<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Image Compressor</title>
    <meta name="theme-color" content="#1a1a1a">
    
    <link rel="stylesheet" href="../../css/style.css">

    <style>
        body { background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        .module-header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .back-btn { text-decoration: none; color: #888; font-size: 1.1rem; transition: 0.2s; }
        .back-btn:hover { color: #fff; }
        .module-title { font-size: 1.5rem; font-weight: 800; color: #ff9100; text-transform: uppercase; letter-spacing: 2px; }

        .layout-grid { display: grid; grid-template-columns: 1fr 320px; gap: 25px; align-items: start; }
        @media (max-width: 800px) { .layout-grid { grid-template-columns: 1fr; } }

        /* Left: Preview */
        .preview-area {
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 10px;
            text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center;
        }
        .drop-zone {
            border: 2px dashed #444; border-radius: 10px; padding: 40px; cursor: pointer; transition: 0.3s;
            height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .drop-zone:hover { border-color: #ff9100; background: rgba(255, 145, 0, 0.05); }
        
        .img-wrapper { position: relative; display: none; overflow: hidden; border-radius: 8px; border: 1px solid #444; }
        .img-wrapper img { max-width: 100%; display: block; transition: transform 0.2s; }
        /* Zoom effect on hover to check artifacts */
        .img-wrapper:hover img { transform: scale(1.5); cursor: zoom-in; }

        /* Right: Controls */
        .control-panel { background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 12px; }
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; }

        /* Slider */
        input[type=range] { width: 100%; accent-color: #ff9100; cursor: pointer; height: 5px; border-radius: 5px; }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.7rem; color: #555; margin-top: 5px; }
        .quality-display { font-size: 2rem; font-weight: 800; color: #ff9100; text-align: center; margin-bottom: 5px; }
        .quality-desc { text-align: center; color: #aaa; font-size: 0.8rem; margin-bottom: 20px; }

        /* Stats Cards */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #222; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-val { font-weight: bold; font-size: 0.9rem; color: #fff; }
        .stat-lbl { font-size: 0.7rem; color: #777; }
        
        .savings-badge { 
            background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; 
            padding: 8px; border-radius: 6px; text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 0.9rem;
        }

        /* Download Button */
        .btn-compress {
            background: linear-gradient(135deg, #ff9100, #ffea00); color: #000;
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-compress:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(255, 145, 0, 0.4); }
        .btn-compress:disabled { background: #333; color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .format-select { width: 100%; background: #222; color: #fff; padding: 10px; border: 1px solid #444; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="module-header">
            <a href="../../index.html" class="back-btn">‚¨Ö Dashboard</a>
            <div class="module-title">Smart Compressor</div>
        </div>

        <div class="layout-grid">
            <div class="preview-area">
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div style="font-size:3rem;">üóúÔ∏è</div>
                    <div style="margin:10px 0; font-weight:bold; color:#ccc;">Select Image</div>
                    <div style="font-size:0.8rem; color:#666;">Supports JPG, PNG, WEBP</div>
                    <input type="file" id="file-input" accept="image/*" style="display:none;">
                </div>
                
                <div class="img-wrapper" id="img-wrapper">
                    <img id="preview-img" alt="Compressed Preview">
                    <div style="position:absolute; bottom:10px; left:0; right:0; text-align:center; pointer-events:none;">
                        <span style="background:rgba(0,0,0,0.7); color:#fff; padding:4px 8px; border-radius:4px; font-size:0.7rem;">Hover to Zoom (Check Artifacts)</span>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                
                <label>Output Format</label>
                <select id="format-select" class="format-select" onchange="processCompression()">
                    <option value="image/jpeg">JPG (Standard)</option>
                    <option value="image/webp" selected>WEBP (Best Compression)</option>
                </select>

                <div class="control-group">
                    <label>Compression Level</label>
                    <div class="quality-display" id="q-val-display">80%</div>
                    <div class="quality-desc" id="q-desc">Balanced Quality</div>
                    <input type="range" id="quality" min="0.1" max="1.0" step="0.05" value="0.8" oninput="updateUI(this.value)" onchange="processCompression()">
                    <div class="range-labels">
                        <span>Smallest</span>
                        <span>Highest</span>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-lbl">Original</div>
                        <div class="stat-val" id="size-ori">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-lbl">Compressed</div>
                        <div class="stat-val" id="size-comp" style="color:#ff9100;">-</div>
                    </div>
                </div>

                <div class="savings-badge" id="savings-badge">
                    Waiting for file...
                </div>

                <button class="btn-compress" id="btn-dl" onclick="downloadFile()" disabled>
                    ‚¨á Save Image
                </button>

            </div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const previewImg = document.getElementById('preview-img');
        const imgWrapper = document.getElementById('img-wrapper');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let originalFile = null;
        let compressedBlob = null;

        // --- Drag & Drop ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#ff9100'; });
        dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = '#444');
        dropZone.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            dropZone.style.borderColor = '#444';
            handleFile(e.dataTransfer.files[0]); 
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            originalFile = file;
            document.getElementById('size-ori').innerText = formatBytes(file.size);
            
            dropZone.style.display = 'none';
            imgWrapper.style.display = 'block';

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Initial process
                    processCompression(img);
                }
            };
            reader.readAsDataURL(file);
        }

        function updateUI(val) {
            const pct = Math.round(val * 100);
            document.getElementById('q-val-display').innerText = pct + "%";
            
            let desc = "";
            if(pct < 30) desc = "Pixelated (Maximum Saving)";
            else if(pct < 60) desc = "Low Quality (Web/Thumbnails)";
            else if(pct < 85) desc = "Balanced (Recommended)";
            else desc = "High Fidelity (Print)";
            document.getElementById('q-desc').innerText = desc;
        }

        function processCompression(loadedImg = null) {
            if(!originalFile) return;

            const format = document.getElementById('format-select').value;
            const quality = parseFloat(document.getElementById('quality').value);
            const btn = document.getElementById('btn-dl');
            
            // Draw to canvas
            // Handle transparency for JPG
            if (format === 'image/jpeg') {
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // If called from handleFile, loadedImg is passed. If slider change, we need source.
            // But we can't get source easily without reloading. 
            // Better approach: Draw once to canvas, then use canvas as source? No, artifacting.
            // Let's reload original to temp image for cleanliness.
            
            const tempImg = new Image();
            tempImg.src = URL.createObjectURL(originalFile);
            tempImg.onload = () => {
                ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);
                
                // Compress
                canvas.toBlob((blob) => {
                    compressedBlob = blob;
                    
                    // Update Preview Image
                    const url = URL.createObjectURL(blob);
                    previewImg.src = url;
                    
                    // Stats
                    document.getElementById('size-comp').innerText = formatBytes(blob.size);
                    const saved = originalFile.size - blob.size;
                    const savedPct = Math.round((saved / originalFile.size) * 100);
                    
                    const badge = document.getElementById('savings-badge');
                    if (saved > 0) {
                        badge.innerText = `üî• SAVED ${savedPct}% (${formatBytes(saved)})`;
                        badge.style.color = "#00ff88";
                        badge.style.borderColor = "#00ff88";
                        badge.style.background = "rgba(0, 255, 136, 0.1)";
                    } else {
                        badge.innerText = `‚ö†Ô∏è LARGER FILE (+${Math.abs(savedPct)}%)`;
                        badge.style.color = "#ff4081";
                        badge.style.borderColor = "#ff4081";
                        badge.style.background = "rgba(255, 64, 129, 0.1)";
                    }

                    btn.disabled = false;
                }, format, quality);
            };
        }

        function downloadFile() {
            if (!compressedBlob) return;
            const format = document.getElementById('format-select').value;
            let ext = format === "image/webp" ? "webp" : "jpg";
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(compressedBlob);
            link.download = `GXDiag-Compressed.${ext}`;
            link.click();
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
