<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Voice Studio</title>
    <meta name="theme-color" content="#1a1a1a">
    
    <link rel="stylesheet" href="../../css/style.css">

    <style>
        body { background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .module-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .back-btn { text-decoration: none; color: #888; font-size: 1.1rem; }
        .back-btn:hover { color: #fff; }
        .module-title { font-size: 1.4rem; font-weight: 800; color: #00e5ff; text-transform: uppercase; letter-spacing: 2px; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn {
            background: #1a1a1a; border: none; padding: 12px 20px; color: #888;
            cursor: pointer; font-size: 0.9rem; font-weight: bold; border-radius: 8px 8px 0 0;
            transition: 0.3s; flex: 1; text-align: center;
        }
        .tab-btn:hover { background: #222; color: #fff; }
        .tab-btn.active { background: #222; color: #00e5ff; border-bottom: 3px solid #00e5ff; }

        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT AREA */
        textarea {
            width: 100%; height: 150px; background: #151515; border: 1px solid #333;
            color: #fff; padding: 15px; border-radius: 10px; resize: vertical;
            font-size: 1rem; line-height: 1.5; margin-bottom: 15px;
        }
        textarea:focus { outline: none; border-color: #00e5ff; }

        /* CONTROLS GRID */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media(max-width: 600px) { .controls-grid { grid-template-columns: 1fr; } }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        
        select {
            background: #222; border: 1px solid #444; color: #fff; padding: 10px;
            border-radius: 6px; cursor: pointer;
        }

        /* Range Sliders */
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00e5ff; }

        /* BUTTONS */
        .action-bar { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: 0.2s; color: #fff;
        }
        .btn-primary { background: linear-gradient(135deg, #00b0ff, #00e5ff); color: #000; }
        .btn-primary:hover { box-shadow: 0 0 15px rgba(0, 229, 255, 0.4); }
        
        .btn-danger { background: #ff4081; color: #fff; }
        .btn-secondary { background: #333; color: #ccc; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* VISUALIZER (STT) */
        .mic-visualizer {
            height: 60px; display: flex; align-items: center; justify-content: center; gap: 5px;
            margin-bottom: 15px; opacity: 0.3; transition: 0.3s;
        }
        .mic-visualizer.listening { opacity: 1; }
        .bar { width: 6px; background: #00e5ff; border-radius: 3px; animation: none; height: 10px; }
        .listening .bar { animation: soundWave 0.5s infinite ease-in-out alternate; }
        .listening .bar:nth-child(1) { animation-delay: 0.1s; }
        .listening .bar:nth-child(2) { animation-delay: 0.2s; }
        .listening .bar:nth-child(3) { animation-delay: 0.3s; }
        .listening .bar:nth-child(4) { animation-delay: 0.4s; }
        .listening .bar:nth-child(5) { animation-delay: 0.5s; }

        @keyframes soundWave { 0% { height: 10px; } 100% { height: 50px; } }

        .status-badge {
            display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem;
            margin-bottom: 10px; font-weight: bold;
        }
        .st-idle { background: #333; color: #aaa; }
        .st-listening { background: rgba(0, 255, 136, 0.2); color: #00ff88; border: 1px solid #00ff88; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="module-header">
            <a href="../../index.html" class="back-btn">‚¨Ö Dashboard</a>
            <div class="module-title">Voice Studio</div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tts')">üó£Ô∏è Text to Speech (Reader)</button>
            <button class="tab-btn" onclick="switchTab('stt')">üéôÔ∏è Speech to Text (Writer)</button>
        </div>

        <div id="panel-tts" class="panel active">
            <div style="margin-bottom:10px; color:#aaa; font-size:0.8rem;">Type text below and choose a voice to narrate it.</div>
            <textarea id="tts-input" placeholder="Enter text here to convert to speech... (e.g., 'Selamat pagi, sistem GXDiag siap digunakan.')"></textarea>
            
            <div class="controls-grid">
                <div class="control-group">
                    <label>Voice / Language</label>
                    <select id="voice-select"><option>Loading voices...</option></select>
                </div>
                <div class="control-group">
                    <label>Speed (Rate)</label>
                    <input type="range" id="rate" min="0.5" max="2" value="1" step="0.1">
                    <div style="text-align:right; font-size:0.7rem; color:#aaa;" id="rate-val">1x</div>
                </div>
                <div class="control-group">
                    <label>Pitch</label>
                    <input type="range" id="pitch" min="0" max="2" value="1" step="0.1">
                    <div style="text-align:right; font-size:0.7rem; color:#aaa;" id="pitch-val">1</div>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-primary" onclick="speakText()">‚ñ∂ Play</button>
                <button class="btn btn-secondary" onclick="pauseText()">II Pause</button>
                <button class="btn btn-secondary" onclick="resumeText()">‚ñ∂ Resume</button>
                <button class="btn btn-danger" onclick="stopText()">‚ñ† Stop</button>
            </div>
        </div>

        <div id="panel-stt" class="panel">
            <div class="mic-visualizer" id="visualizer">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div id="stt-status" class="status-badge st-idle">MICROPHONE IDLE</div>
                <select id="stt-lang" style="padding:5px;">
                    <option value="id-ID">üáÆüá© Indonesian</option>
                    <option value="en-US">üá∫üá∏ English (US)</option>
                    <option value="ja-JP">üáØüáµ Japanese</option>
                </select>
            </div>

            <textarea id="stt-output" placeholder="Results will appear here. Click 'Start Listening' and speak clearly..." readonly></textarea>

            <div class="action-bar">
                <button id="btn-listen" class="btn btn-primary" onclick="toggleListening()">üéôÔ∏è Start Listening</button>
                <button class="btn btn-secondary" onclick="copyToClipboard()">üìã Copy Text</button>
                <button class="btn btn-secondary" onclick="downloadText()">üíæ Save as .txt</button>
                <button class="btn btn-danger" onclick="clearText()">üóëÔ∏è Clear</button>
            </div>
        </div>

    </div>

    <script>
        // --- TAB LOGIC ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        // --- TTS LOGIC (Text to Speech) ---
        const synth = window.speechSynthesis;
        const inputTxt = document.getElementById('tts-input');
        const voiceSelect = document.getElementById('voice-select');
        const pitch = document.getElementById('pitch');
        const rate = document.getElementById('rate');
        let voices = [];

        function populateVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';
            
            // Prioritize ID/EN voices
            voices.sort(function (a, b) {
                const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
                if ( aname < bname ) return -1;
                else if ( aname == bname ) return 0;
                return +1;
            });

            voices.forEach((voice) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-lang', voice.lang);
                option.setAttribute('data-name', voice.name);
                
                // Auto select Google Bahasa Indonesia if available
                if(voice.lang === 'id-ID') option.selected = true;
                
                voiceSelect.appendChild(option);
            });
        }

        populateVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoices;
        }

        // Update Slider Values UI
        pitch.oninput = () => document.getElementById('pitch-val').innerText = pitch.value;
        rate.oninput = () => document.getElementById('rate-val').innerText = rate.value + 'x';

        function speakText() {
            if (synth.speaking) { console.error('Already speaking'); return; }
            if (inputTxt.value !== '') {
                const utterThis = new SpeechSynthesisUtterance(inputTxt.value);
                const selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
                
                for (let i = 0; i < voices.length; i++) {
                    if (voices[i].name === selectedOption) {
                        utterThis.voice = voices[i];
                        break;
                    }
                }
                utterThis.pitch = pitch.value;
                utterThis.rate = rate.value;
                synth.speak(utterThis);
            }
        }
        function pauseText() { if(synth.speaking) synth.pause(); }
        function resumeText() { if(synth.paused) synth.resume(); }
        function stopText() { if(synth.speaking) synth.cancel(); }

        // --- STT LOGIC (Speech to Text) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const sttOutput = document.getElementById('stt-output');
        const sttStatus = document.getElementById('stt-status');
        const visualizer = document.getElementById('visualizer');
        const btnListen = document.getElementById('btn-listen');
        const langSelect = document.getElementById('stt-lang');

        let recognition;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening
            recognition.interimResults = true; // Show text while speaking

            recognition.onstart = function() {
                isListening = true;
                sttStatus.innerText = "LISTENING...";
                sttStatus.className = "status-badge st-listening";
                visualizer.classList.add('listening');
                btnListen.innerText = "üõë Stop Listening";
                btnListen.classList.remove('btn-primary');
                btnListen.classList.add('btn-danger');
            };

            recognition.onerror = function(event) {
                console.error(event.error);
                sttStatus.innerText = "ERROR: " + event.error;
                stopListeningUI();
            };

            recognition.onend = function() {
                stopListeningUI();
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                // Append logic: only add finalized text to existing text
                if (finalTranscript) {
                    // Cek agar tidak duplikat jika event fire berkali-kali
                    const currentText = sttOutput.value;
                    sttOutput.value = currentText + (currentText ? " " : "") + finalTranscript;
                }
            };
        } else {
            sttOutput.value = "‚ö†Ô∏è Browser Anda tidak mendukung Web Speech API. Gunakan Google Chrome/Edge.";
            btnListen.disabled = true;
        }

        function toggleListening() {
            if (!recognition) return;
            if (isListening) {
                recognition.stop();
            } else {
                recognition.lang = langSelect.value;
                recognition.start();
            }
        }

        function stopListeningUI() {
            isListening = false;
            sttStatus.innerText = "MICROPHONE IDLE";
            sttStatus.className = "status-badge st-idle";
            visualizer.classList.remove('listening');
            btnListen.innerText = "üéôÔ∏è Start Listening";
            btnListen.classList.remove('btn-danger');
            btnListen.classList.add('btn-primary');
        }

        function clearText() { sttOutput.value = ""; }
        
        function copyToClipboard() {
            sttOutput.select();
            document.execCommand('copy');
            alert("Text copied to clipboard!");
        }

        function downloadText() {
            const text = sttOutput.value;
            if(!text) return;
            const blob = new Blob([text], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = `GXDiag-Note-${new Date().toISOString().slice(0,10)}.txt`;
            anchor.href = window.URL.createObjectURL(blob);
            anchor.target = '_blank';
            anchor.style.display = 'none';
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }
    </script>
</body>
</html>
