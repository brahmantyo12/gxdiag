<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Screen & Cam</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body { background: #000; color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-family: sans-serif; }
        
        /* HEADER */
        .mod-header { padding: 15px 20px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; font-size: 0.9rem; }
        
        .main-container { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10; }
        
        /* FPS COUNTER */
        .fps-box {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.7); border: 1px solid #00ff88;
            padding: 5px 15px; border-radius: 8px; font-family: monospace;
            color: #00ff88; font-weight: bold; z-index: 5; font-size: 0.9rem;
        }

        /* MENU GRID */
        .btn-grid { display: grid; grid-template-columns: 1fr; gap: 15px; max-width: 350px; width: 100%; z-index: 5; }
        .test-btn { 
            padding: 18px; background: #1a1a1a; border: 1px solid #333; color: #ccc; 
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            text-align: left; transition: 0.2s;
        }
        .test-btn:hover { background: #222; border-color: #00e5ff; color: #fff; transform: translateX(5px); }
        .btn-icon { font-size: 1.5rem; }

        /* --- 1. DEAD PIXEL OVERLAY --- */
        #color-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; cursor: pointer; }

        /* --- 2. PIXEL REPAIR OVERLAY --- */
        #repair-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; display: none; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Repair Controls */
        .repair-ui {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 10px; 
            border-radius: 40px; border: 1px solid #333;
        }
        .mode-btn {
            background: #222; border: 1px solid #444; color: #fff; width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }
        .mode-btn.active { background: #00e5ff; color: #000; box-shadow: 0 0 15px #00e5ff; }
        .close-repair { background: #ff4081 !important; color: #fff !important; }

        /* WARNING MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;
        }
        .agree-btn { margin-top: 20px; background: #ff4081; color: #fff; border: none; padding: 12px 30px; font-weight: bold; border-radius: 30px; cursor: pointer; }

        /* --- 3. WEBCAM --- */
        #cam-container { display: none; flex-direction: column; align-items: center; width: 100%; margin-top: 20px;}
        #cam-feed { width: 90%; max-width: 500px; border: 2px solid #333; border-radius: 10px; background: #000; }
        .cam-info { margin-top: 10px; color: #888; font-size: 0.8rem; font-family: monospace; }
        .stop-cam-btn { margin-top: 15px; background: #333; color: #fff; border: 1px solid #555; padding: 8px 20px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="modal" id="warning-modal">
        <div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div>
        <h2 style="color:#ff4081; margin:0;">EPILEPSY WARNING</h2>
        <p style="color:#ccc; line-height:1.5; font-size:0.9rem; max-width:400px; margin-top:10px;">
            Fitur Repair menggunakan pola <b>kedip cepat (strobe)</b> dan noise statis. 
            Jangan gunakan jika Anda memiliki riwayat epilepsi atau sensitif terhadap cahaya.
        </p>
        <button class="agree-btn" onclick="confirmRepair()">SAYA MENGERTI</button>
        <button class="agree-btn" style="background:transparent; border:1px solid #555; margin-top:10px;" onclick="closeModal()">BATAL</button>
    </div>

    <div class="mod-header">
        <a href="../../index.html" class="back-btn">‚Üê DASHBOARD</a>
        <div style="font-size:0.9rem; color:#888;">DISPLAY & CAM</div>
    </div>

    <div class="main-container">
        <div class="fps-box" id="fps-display">FPS: --</div>

        <div class="btn-grid" id="menu-grid">
            <button class="test-btn" onclick="startDeadPixel()">
                <span class="btn-icon">üñ•Ô∏è</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Dead Pixel Test</div>
                    <div style="font-size:0.75rem;">Cek warna layar solid</div>
                </div>
            </button>
            <button class="test-btn" onclick="showWarning()">
                <span class="btn-icon">üõ†Ô∏è</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Pixel Repair</div>
                    <div style="font-size:0.75rem;">Perbaiki burn-in & stuck pixel</div>
                </div>
            </button>
            <button class="test-btn" onclick="startWebcam()">
                <span class="btn-icon">üì∏</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Webcam Check</div>
                    <div style="font-size:0.75rem;">Tes kamera depan/belakang</div>
                </div>
            </button>
        </div>

        <div id="cam-container">
            <video id="cam-feed" autoplay playsinline></video>
            <div class="cam-info" id="cam-info">Connecting...</div>
            <button class="stop-cam-btn" onclick="stopWebcam()">Stop Camera</button>
        </div>
    </div>

    <div id="color-overlay" onclick="nextColor()"></div>
    
    <div id="repair-layer">
        <canvas id="repair-canvas"></canvas>
        <div class="repair-ui">
            <button class="mode-btn active" onclick="setRepairMode('noise')">üì∫</button>
            <button class="mode-btn" onclick="setRepairMode('rgb')">üåà</button>
            <button class="mode-btn" onclick="setRepairMode('bw')">‚ö™</button>
            <button class="mode-btn close-repair" onclick="stopRepair()">‚úñ</button>
        </div>
    </div>

    <script>
        // --- 1. GLOBAL FPS LOGIC ---
        let lastLoop = new Date();
        function countFPS() { 
            let thisLoop = new Date();
            let fps = 1000 / (thisLoop - lastLoop);
            lastLoop = thisLoop;
            document.getElementById('fps-display').innerText = "FPS: " + Math.round(fps);
            requestAnimationFrame(countFPS);
        }
        requestAnimationFrame(countFPS);

        // --- 2. DEAD PIXEL LOGIC ---
        const overlay = document.getElementById('color-overlay');
        const colors = ['red', 'green', 'blue', 'white', 'black'];
        let colorIdx = 0;

        function startDeadPixel() {
            colorIdx = 0;
            overlay.style.backgroundColor = colors[colorIdx];
            overlay.style.display = 'block';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }

        function nextColor() {
            colorIdx++;
            if (colorIdx >= colors.length) {
                overlay.style.display = 'none';
                if(document.fullscreenElement) document.exitFullscreen();
            } else {
                overlay.style.backgroundColor = colors[colorIdx];
            }
        }

        // --- 3. PIXEL REPAIR LOGIC ---
        const repairLayer = document.getElementById('repair-layer');
        const canvas = document.getElementById('repair-canvas');
        const ctx = canvas.getContext('2d');
        let repairMode = 'noise';
        let repairRunning = false;
        let width, height;

        function showWarning() { document.getElementById('warning-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('warning-modal').style.display = 'none'; }
        
        function confirmRepair() {
            closeModal();
            repairLayer.style.display = 'block';
            resizeCanvas();
            repairRunning = true;
            repairLoop();
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }

        function stopRepair() {
            repairRunning = false;
            repairLayer.style.display = 'none';
            if(document.fullscreenElement) document.exitFullscreen();
        }

        function setRepairMode(m) {
            repairMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function repairLoop() {
            if(!repairRunning) return;

            if (repairMode === 'noise') {
                const idata = ctx.createImageData(width, height);
                const buffer32 = new Uint32Array(idata.data.buffer);
                for (let i = 0; i < buffer32.length; i++) {
                    buffer32[i] = (255 << 24) | ((Math.random() * 255) << 16) | ((Math.random() * 255) << 8) | (Math.random() * 255);
                }
                ctx.putImageData(idata, 0, 0);
            } else if (repairMode === 'rgb') {
                const cols = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff'];
                ctx.fillStyle = cols[Math.floor(Math.random() * cols.length)];
                ctx.fillRect(0, 0, width, height);
            } else if (repairMode === 'bw') {
                ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#000';
                ctx.fillRect(0, 0, width, height);
            }
            requestAnimationFrame(repairLoop);
        }

        // --- 4. WEBCAM LOGIC ---
        let streamRef = null;
        async function startWebcam() {
            const container = document.getElementById('cam-container');
            const menu = document.getElementById('menu-grid');
            const video = document.getElementById('cam-feed');
            const info = document.getElementById('cam-info');

            menu.style.display = 'none'; // Hide menu
            container.style.display = 'flex';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                streamRef = stream;
                video.srcObject = stream;
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                info.innerText = `Active: ${track.label} (${settings.width}x${settings.height})`;
            } catch (err) {
                info.innerText = "Error: Camera Access Denied";
                info.style.color = "#ff4081";
            }
        }

        function stopWebcam() {
            if (streamRef) {
                streamRef.getTracks().forEach(track => track.stop());
                streamRef = null;
            }
            document.getElementById('cam-container').style.display = 'none';
            document.getElementById('menu-grid').style.display = 'grid'; // Show menu again
        }
    </script>
</body>
</html>
