<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GXDiag - Screen & Cam</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body { 
            background: #000; color: #fff; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; font-family: sans-serif;
            margin: 0; padding: 0; touch-action: none;
        }
        
        /* HEADER */
        .mod-header { 
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; align-items: center; z-index: 50; flex-shrink: 0;
        }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; font-size: 0.9rem; }
        
        .main-container { 
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; position: relative; z-index: 10;
            width: 100%; overflow-y: auto; padding: 20px;
        }
        
        /* FPS COUNTER */
        .fps-box {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.7); border: 1px solid #00ff88;
            padding: 5px 10px; border-radius: 8px; font-family: monospace;
            color: #00ff88; font-weight: bold; z-index: 60; font-size: 0.8rem;
        }

        /* MENU GRID (RESPONSIVE) */
        .btn-grid { 
            display: grid; grid-template-columns: 1fr; gap: 15px; 
            width: 100%; max-width: 400px; z-index: 5; 
        }
        .test-btn { 
            padding: 20px; background: #1a1a1a; border: 1px solid #333; color: #ccc; 
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            text-align: left; transition: 0.2s; width: 100%;
        }
        .test-btn:hover, .test-btn:active { background: #222; border-color: #00e5ff; color: #fff; transform: scale(0.98); }
        .btn-icon { font-size: 1.8rem; }

        /* --- 1. DEAD PIXEL OVERLAY --- */
        #color-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; cursor: pointer; }
        .dp-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.5); font-size: 1rem; pointer-events: none; text-align: center;
        }

        /* --- 2. PIXEL REPAIR OVERLAY --- */
        #repair-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; display: none; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* Repair Controls */
        .repair-ui {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: rgba(0,0,0,0.8); padding: 15px; 
            border-radius: 40px; border: 1px solid #333; z-index: 100;
        }
        .mode-btn {
            background: #222; border: 1px solid #444; color: #fff; width: 50px; height: 50px;
            border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
        }
        .mode-btn.active { background: #00e5ff; color: #000; box-shadow: 0 0 15px #00e5ff; }
        .close-repair { background: #ff4081 !important; color: #fff !important; }

        /* --- 3. GRID TOUCH TEST (XIAOMI STYLE) --- */
        #grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 95; display: none; background: #000;
        }
        #grid-container {
            display: grid; width: 100%; height: 100%;
        }
        .grid-cell {
            border: 1px solid #333; background: #111; transition: background 0.1s;
        }
        .grid-cell.touched { background: #00ff88; border-color: #00cc6a; }
        .grid-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 100;
        }
        .grid-ui button { pointer-events: auto; margin-top: 10px; padding: 8px 20px; border-radius: 20px; border: none; background: #fff; color: #000; font-weight: bold; }

        /* WARNING MODAL */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        .agree-btn { margin-top: 20px; background: #ff4081; color: #fff; border: none; padding: 12px 30px; font-weight: bold; border-radius: 30px; cursor: pointer; width: 100%; max-width: 200px; }

        /* --- 4. WEBCAM --- */
        #cam-container { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; justify-content: center;}
        #cam-feed { width: 100%; max-height: 70vh; object-fit: contain; background: #000; transform: scaleX(-1); }
        .cam-info-box {
            background: rgba(20,20,20,0.9); padding: 15px; border-radius: 10px; border: 1px solid #333;
            margin-top: 15px; text-align: center; width: 100%; max-width: 400px;
        }
        .stop-cam-btn { margin-top: 10px; background: #ff1744; color: #fff; border: none; padding: 10px 30px; border-radius: 20px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>

    <div class="modal" id="warning-modal">
        <div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div>
        <h2 style="color:#ff4081; margin:0;">EPILEPSY WARNING</h2>
        <p style="color:#ccc; line-height:1.5; font-size:0.9rem; max-width:400px; margin-top:10px;">
            Fitur Repair menggunakan pola <b>kedip cepat (strobe)</b> dan noise statis. 
            Jangan gunakan jika Anda memiliki riwayat epilepsi atau sensitif terhadap cahaya.
        </p>
        <button class="agree-btn" onclick="confirmRepair()">SAYA MENGERTI</button>
        <button class="agree-btn" style="background:transparent; border:1px solid #555; margin-top:10px;" onclick="closeModal()">BATAL</button>
    </div>

    <div class="mod-header">
        <a href="../../index.html" class="back-btn">‚Üê DASHBOARD</a>
        <div style="font-size:0.9rem; color:#888;">DISPLAY & CAM</div>
    </div>

    <div class="fps-box" id="fps-display">FPS: --</div>

    <div class="main-container">
        <div class="btn-grid" id="menu-grid">
            <button class="test-btn" onclick="startDeadPixel()">
                <span class="btn-icon">üñ•Ô∏è</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Dead Pixel Test</div>
                    <div style="font-size:0.75rem;">Cek warna layar solid</div>
                </div>
            </button>
            <button class="test-btn" onclick="initGrid()">
                <span class="btn-icon">üëÜ</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Grid Touch Test</div>
                    <div style="font-size:0.75rem;">Cek respon layar sentuh</div>
                </div>
            </button>
            <button class="test-btn" onclick="showWarning()">
                <span class="btn-icon">üõ†Ô∏è</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Pixel Repair</div>
                    <div style="font-size:0.75rem;">Perbaiki burn-in & stuck pixel</div>
                </div>
            </button>
            <button class="test-btn" onclick="startWebcam()">
                <span class="btn-icon">üì∏</span>
                <div>
                    <div style="font-weight:bold; color:#fff;">Webcam Check</div>
                    <div style="font-size:0.75rem;">Tes kamera & resolusi</div>
                </div>
            </button>
        </div>

        <div id="cam-container">
            <video id="cam-feed" autoplay playsinline></video>
            <div class="cam-info-box">
                <div id="cam-res" style="color:#fff; font-weight:bold;">Resolution: -</div>
                <div id="cam-fps" style="color:#888; font-size:0.8rem; margin-top:5px;">FrameRate: -</div>
            </div>
            <button class="stop-cam-btn" onclick="stopWebcam()">STOP CAMERA</button>
        </div>
    </div>

    <div id="color-overlay" onclick="nextColor()">
        <div class="dp-hint" id="dp-hint">TAP TO CHANGE COLOR</div>
    </div>
    
    <div id="repair-layer">
        <canvas id="repair-canvas"></canvas>
        <div class="repair-ui">
            <button class="mode-btn active" onclick="setRepairMode('noise')">üì∫</button>
            <button class="mode-btn" onclick="setRepairMode('rgb')">üåà</button>
            <button class="mode-btn" onclick="setRepairMode('bw')">‚ö™</button>
            <button class="mode-btn close-repair" onclick="stopRepair()">‚úñ</button>
        </div>
    </div>

    <div id="grid-overlay">
        <div id="grid-container"></div>
        <div class="grid-ui" id="grid-success" style="display:none;">
            <div style="font-size:3rem;">‚úÖ</div>
            <div style="font-weight:bold; font-size:1.2rem; margin-top:10px;">PASS!</div>
            <div style="color:#888; font-size:0.9rem;">Digitizer Normal</div>
            <button onclick="stopGrid()">CLOSE</button>
        </div>
        <div style="position:absolute; top:20px; left:0; width:100%; text-align:center; pointer-events:none; z-index:90;">
            <span style="background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:5px; font-size:0.8rem;">Usap semua kotak</span>
        </div>
        <button onclick="stopGrid()" style="position:absolute; top:20px; right:20px; background:#ff1744; border:none; color:#fff; width:30px; height:30px; border-radius:50%; font-weight:bold; z-index:100;">‚úï</button>
    </div>

    <script>
        // --- GLOBAL FPS LOGIC ---
        let lastLoop = performance.now();
        let frames = 0;
        function countFPS() { 
            let now = performance.now();
            frames++;
            if (now - lastLoop >= 1000) {
                document.getElementById('fps-display').innerText = frames + " Hz";
                frames = 0;
                lastLoop = now;
            }
            requestAnimationFrame(countFPS);
        }
        countFPS();

        // --- 1. DEAD PIXEL LOGIC ---
        const overlay = document.getElementById('color-overlay');
        const colors = ['red', 'green', 'blue', 'white', 'black', 'gray'];
        let colorIdx = 0;

        function startDeadPixel() {
            colorIdx = 0;
            overlay.style.backgroundColor = colors[colorIdx];
            overlay.style.display = 'block';
            document.getElementById('dp-hint').style.display = 'block';
            setTimeout(() => document.getElementById('dp-hint').style.display = 'none', 2000);
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e=>{});
        }

        function nextColor() {
            colorIdx++;
            if (colorIdx >= colors.length) {
                overlay.style.display = 'none';
                if(document.exitFullscreen) document.exitFullscreen().catch(e=>{});
            } else {
                overlay.style.backgroundColor = colors[colorIdx];
            }
        }

        // --- 2. PIXEL REPAIR LOGIC ---
        const repairLayer = document.getElementById('repair-layer');
        const canvas = document.getElementById('repair-canvas');
        const ctx = canvas.getContext('2d');
        let repairMode = 'noise';
        let repairRunning = false;
        let width, height;

        function showWarning() { document.getElementById('warning-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('warning-modal').style.display = 'none'; }
        
        function confirmRepair() {
            closeModal();
            repairLayer.style.display = 'block';
            resizeCanvas();
            repairRunning = true;
            repairLoop();
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e=>{});
        }

        function stopRepair() {
            repairRunning = false;
            repairLayer.style.display = 'none';
            if(document.exitFullscreen) document.exitFullscreen().catch(e=>{});
        }

        function setRepairMode(m) {
            repairMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function repairLoop() {
            if(!repairRunning) return;

            if (repairMode === 'noise') {
                const idata = ctx.createImageData(width, height);
                const buffer32 = new Uint32Array(idata.data.buffer);
                for (let i = 0; i < buffer32.length; i++) {
                    buffer32[i] = (255 << 24) | ((Math.random() * 255) << 16) | ((Math.random() * 255) << 8) | (Math.random() * 255);
                }
                ctx.putImageData(idata, 0, 0);
            } else if (repairMode === 'rgb') {
                const cols = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#00ffff', '#ff00ff'];
                ctx.fillStyle = cols[Math.floor(Math.random() * cols.length)];
                ctx.fillRect(0, 0, width, height);
            } else if (repairMode === 'bw') {
                ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#000';
                ctx.fillRect(0, 0, width, height);
            }
            requestAnimationFrame(repairLoop);
        }

        // --- 3. GRID TOUCH LOGIC (NEW) ---
        const gridOverlay = document.getElementById('grid-overlay');
        const gridContainer = document.getElementById('grid-container');
        let totalCells = 0, touchedCells = 0;

        function initGrid() {
            gridOverlay.style.display = 'block';
            gridContainer.innerHTML = '';
            document.getElementById('grid-success').style.display = 'none';
            touchedCells = 0;
            
            // Grid Calculation
            const cols = 9; 
            const rows = Math.floor(window.innerHeight / (window.innerWidth / cols));
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gridContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            totalCells = cols * rows;

            for(let i=0; i<totalCells; i++) {
                const div = document.createElement('div');
                div.className = 'grid-cell';
                gridContainer.appendChild(div);
            }

            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e=>{});
        }

        function handleMove(e) {
            e.preventDefault();
            const points = e.touches ? e.touches : [e];
            for(let i=0; i<points.length; i++) {
                const touch = points[i];
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                if(el && el.classList.contains('grid-cell') && !el.classList.contains('touched')) {
                    el.classList.add('touched');
                    touchedCells++;
                    if(touchedCells >= totalCells) {
                        document.getElementById('grid-success').style.display = 'block';
                        if(navigator.vibrate) navigator.vibrate(200);
                    }
                }
            }
        }

        gridContainer.addEventListener('touchmove', handleMove, {passive: false});
        gridContainer.addEventListener('mousemove', (e) => { if(e.buttons === 1) handleMove(e); });

        function stopGrid() {
            gridOverlay.style.display = 'none';
            if(document.exitFullscreen) document.exitFullscreen().catch(e=>{});
        }

        // --- 4. WEBCAM LOGIC ---
        let streamRef = null;
        async function startWebcam() {
            const container = document.getElementById('cam-container');
            const menu = document.getElementById('menu-grid');
            const video = document.getElementById('cam-feed');
            
            menu.style.display = 'none';
            container.style.display = 'flex';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 4096 }, height: { ideal: 2160 } } 
                });
                streamRef = stream;
                video.srcObject = stream;
                
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                document.getElementById('cam-res').innerText = `Resolution: ${settings.width} x ${settings.height}`;
                document.getElementById('cam-fps').innerText = `FPS: ${settings.frameRate || 'N/A'}`;
            } catch (err) {
                alert("Camera Access Denied or Not Available");
                stopWebcam();
            }
        }

        function stopWebcam() {
            if (streamRef) {
                streamRef.getTracks().forEach(track => track.stop());
                streamRef = null;
            }
            document.getElementById('cam-container').style.display = 'none';
            document.getElementById('menu-grid').style.display = 'grid';
        }
    </script>
</body>
</html>
