<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>GXDiag - Pro Controller Tester</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        /* LAYOUT UTAMA */
        .main-grid {
            display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 20px;
            width: 100%; max-width: 1280px; align-items: start;
        }

        /* --- SECTION 1: STANDARD CONTROLLER --- */
        .gp-visual-wrapper {
            position: relative; 
            width: 560px; height: 380px; /* Sedikit diperbesar lagi */
            margin: 0 auto;
            background: linear-gradient(145deg, #252525, #151515);
            border-radius: 90px 90px 160px 160px; 
            border: 2px solid #444;
            box-shadow: inset 0 0 40px #000;
        }
        
        /* Tombol Umum */
        .btn-gp {
            position: absolute; display: flex; align-items: center; justify-content: center;
            background: #333; color: #888; border: 2px solid #444; 
            font-size: 10px; font-weight: bold; transition: 0.05s;
            box-shadow: 0 4px 5px rgba(0,0,0,0.5);
        }
        .btn-gp.pressed { 
            background: #00e5ff; color: #000; 
            box-shadow: 0 0 15px #00e5ff; border-color: #fff; transform: scale(0.95); 
        }

        /* --- Triggers (LT/RT Visualizer) - DESAIN BARU --- */
        .trigger-bar-container {
            position: absolute; top: 15px; 
            width: 100px; height: 18px; /* Lebih tebal & lebar */
            background: #111; /* Warna track gelap */
            border: 1px solid #555; 
            overflow: hidden;
            display: flex; align-items: center;
            box-shadow: inset 0 0 5px #000;
        }
        
        /* Bentuk melengkung mengikuti bahu controller */
        .pos-lt-bar { left: 60px; border-radius: 10px 4px 4px 10px; } 
        .pos-rt-bar { right: 60px; border-radius: 4px 10px 10px 4px; flex-direction: row-reverse; } 
        
        .trigger-fill { height: 100%; background: linear-gradient(90deg, #00e5ff, #0099cc); width: 0%; transition: width 0.05s; }
        
        /* Label Trigger (L / R) */
        .trigger-val { 
            position: absolute; top: 20px; /* Pindah ke bawah bar */
            color: #666; font-size: 0.65rem; font-weight: bold; font-family: monospace; 
            width: 100%; text-align: center;
        }

        /* --- Shoulders (LB/RB) --- */
        .gp-sh { width: 100px; height: 28px; border-radius: 8px; }
        .pos-lb { top: 45px; left: 60px; } 
        .pos-rb { top: 45px; right: 60px; }

        /* --- D-Pad (Kiri) --- */
        .gp-dpad { width: 32px; height: 32px; border-radius: 4px; }
        .pos-du { top: 110px; left: 110px; } 
        .pos-dd { top: 178px; left: 110px; } 
        .pos-dl { top: 144px; left: 76px; } 
        .pos-dr { top: 144px; left: 144px; }

        /* --- Face Buttons (Kanan - ABXY) --- */
        .gp-round { width: 40px; height: 40px; border-radius: 50%; }
        .pos-y { top: 100px; right: 110px; } 
        .pos-x { top: 135px; right: 145px; } 
        .pos-b { top: 135px; right: 75px; }  
        .pos-a { top: 170px; right: 110px; } 

        /* --- Analog Sticks (L3/R3) --- */
        .gp-stick { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #555; background: #222; }
        .gp-stick.pressed { background: #005577; border-color: #00e5ff; }
        .pos-ls { top: 210px; left: 170px; } 
        .pos-rs { top: 210px; right: 170px; }

        /* --- Center Buttons --- */
        .gp-small { width: 26px; height: 26px; border-radius: 50%; top: 120px; color: #aaa; font-size: 0.6rem;}
        .pos-sel { left: 220px; } 
        .pos-start { right: 220px; } 
        .pos-home { left: 268px; top: 90px; width: 24px; height: 24px; font-size: 1rem;} 

        /* --- PADDLES (P1-P4) SEJAJAR HORIZONTAL --- */
        .gp-paddle { 
            width: 40px; height: 30px; /* Bentuk lebih lebar */
            border-radius: 6px; bottom: 30px; /* Paling bawah */
            background: #1a1a1a; border-color: #333; 
        }
        /* Urutan: P3 - P1 - [Tengah] - P2 - P4 */
        .pos-p3 { left: 160px; } 
        .pos-p1 { left: 210px; } 
        
        .pos-p2 { right: 210px; } 
        .pos-p4 { right: 160px; }
        
        .paddle-label { position: absolute; bottom: 10px; width: 100%; text-align: center; color: #444; font-size: 0.7rem; letter-spacing: 1px; font-weight: bold; }

        /* DATA MONITOR */
        .monitor-panel {
            margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px dashed #444;
        }
        .mon-row { display: flex; justify-content: space-between; font-family: monospace; font-size: 0.85rem; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .mon-val { color: #00e5ff; font-weight: bold; }

        /* --- SECTION 2: SONY TOUCHPAD --- */
        .ds-wrapper {
            background: #1e1e1e; border: 1px solid #333; border-radius: 15px; padding: 25px;
            display: flex; flex-direction: column; align-items: center; height: 100%;
        }
        .ds-touchpad {
            width: 100%; height: 250px; background: #222; border: 2px solid #444;
            border-radius: 15px; position: relative; overflow: hidden; margin: 20px 0;
            box-shadow: inset 0 0 30px #000;
        }
        .ds-finger {
            position: absolute; width: 40px; height: 40px; border-radius: 50%;
            transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; opacity: 0; transition: opacity 0.1s; pointer-events: none;
        }
        #f1 { background: #00e5ff; box-shadow: 0 0 20px #00e5ff; color: #000; }
        #f2 { background: #ff4081; box-shadow: 0 0 20px #ff4081; color: #000; }
        
        .connect-btn { 
            background: #00a2ff; color: #fff; border: none; padding: 12px 25px; 
            border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .connect-btn:hover { background: #fff; color: #00a2ff; box-shadow: 0 0 15px #00a2ff; }

        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-btn">‚Üê MENU</a>
    <h2>Pro Controller & Deadzone Tester</h2>

    <div class="main-grid">
        
        <div class="panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="gp-name" style="color:#00e5ff; font-weight:bold;">Connect Controller...</span>
                <button onclick="testRumble()" style="background:#ff4081; border:none; color:white; padding:3px 10px; border-radius:4px; font-size:0.7rem; cursor:pointer;">TEST RUMBLE</button>
            </div>

            <div class="gp-visual-wrapper">
                <div class="trigger-bar-container pos-lt-bar">
                    <div class="trigger-val" id="val-lt">L</div>
                    <div class="trigger-fill" id="fill-lt"></div>
                </div>
                <div class="trigger-bar-container pos-rt-bar">
                    <div class="trigger-val" id="val-rt">R</div>
                    <div class="trigger-fill" id="fill-rt"></div>
                </div>

                <div class="btn-gp gp-sh pos-lb" id="b4">LB</div>
                <div class="btn-gp gp-sh pos-rb" id="b5">RB</div>

                <div class="btn-gp gp-stick pos-ls" id="b10">L3</div>
                <div class="btn-gp gp-stick pos-rs" id="b11">R3</div>

                <div class="btn-gp gp-dpad pos-du" id="b12">‚ñ≤</div>
                <div class="btn-gp gp-dpad pos-dd" id="b13">‚ñº</div>
                <div class="btn-gp gp-dpad pos-dl" id="b14">‚óÄ</div>
                <div class="btn-gp gp-dpad pos-dr" id="b15">‚ñ∂</div>

                <div class="btn-gp gp-round pos-y" id="b3" style="color:#eadd00">Y</div>
                <div class="btn-gp gp-round pos-x" id="b2" style="color:#0088ff">X</div>
                <div class="btn-gp gp-round pos-a" id="b0" style="color:#00ff88">A</div>
                <div class="btn-gp gp-round pos-b" id="b1" style="color:#ff4040">B</div>

                <div class="btn-gp gp-small pos-sel" id="b8">Sel</div>
                <div class="btn-gp gp-small pos-start" id="b9">Sta</div>
                <div class="btn-gp gp-small pos-home" id="b16">‚åÇ</div>

                <div class="btn-gp gp-paddle pos-p1" id="b17">P1</div>
                <div class="btn-gp gp-paddle pos-p2" id="b18">P2</div>
                <div class="btn-gp gp-paddle pos-p3" id="b19">P3</div>
                <div class="btn-gp gp-paddle pos-p4" id="b20">P4</div>
                
                <div class="paddle-label">BACK PADDLES / EXTRA BUTTONS</div>
            </div>

            <div class="monitor-panel">
                <div class="mon-row"><span>L-STICK (Axis 0,1)</span> <span class="mon-val" id="mon-ls">0.00, 0.00</span></div>
                <div class="mon-row"><span>R-STICK (Axis 2,3)</span> <span class="mon-val" id="mon-rs">0.00, 0.00</span></div>
                <div class="mon-row"><span>L-TRIGGER (Deadzone)</span> <span class="mon-val" id="mon-lt">0.00</span></div>
                <div class="mon-row"><span>R-TRIGGER (Deadzone)</span> <span class="mon-val" id="mon-rt">0.00</span></div>
            </div>
        </div>

        <div class="ds-wrapper">
            <h3 style="margin-top:0; color:#00a2ff">Sony Touchpad Raw Data</h3>
            <p style="font-size:0.8rem; color:#888; text-align:center;">
                Requires USB Cable + Chrome/Edge.<br>Close Steam/DS4Windows to avoid conflicts.
            </p>
            <button class="connect-btn" id="ds-connect">üîå CONNECT USB</button>
            
            <div class="ds-touchpad">
                <div id="f1" class="ds-finger">1</div>
                <div id="f2" class="ds-finger">2</div>
                <div style="position:absolute; top:50%; width:100%; height:1px; background:#333;"></div>
                <div style="position:absolute; left:50%; height:100%; width:1px; background:#333;"></div>
            </div>
            
            <div style="width:100%; font-family:monospace; font-size:0.85rem;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #444; padding:5px;">
                    <span>Finger 1:</span> <span style="color:#00e5ff" id="ds-val-1">Inactive</span>
                </div>
                <div style="display:flex; justify-content:space-between; padding:5px;">
                    <span>Finger 2:</span> <span style="color:#ff4081" id="ds-val-2">Inactive</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. STANDARD GAMEPAD LOGIC ---
        let gpIndex = null;
        window.addEventListener("gamepadconnected", e => {
            gpIndex = e.gamepad.index;
            document.getElementById('gp-name').innerText = "Connected: " + e.gamepad.id.substring(0, 20) + "...";
            updateLoop();
        });
        window.addEventListener("gamepaddisconnected", e => {
            gpIndex = null;
            document.getElementById('gp-name').innerText = "Connect Controller...";
        });

        function updateLoop() {
            if(gpIndex === null) return;
            const gp = navigator.getGamepads()[gpIndex];
            if(gp) {
                // BUTTONS (0 - 20)
                // Note: Standard only goes to 16. 17-20 are typically Paddles on supported devices/browsers.
                for (let i = 0; i < gp.buttons.length; i++) {
                    const el = document.getElementById('b' + i);
                    if (el) {
                        if (gp.buttons[i].pressed) el.classList.add('pressed');
                        else el.classList.remove('pressed');
                    }
                }

                // TRIGGERS (Analog Handling - Axis vs Button Value)
                // HTML5 Gamepad API maps Triggers to buttons[6] and buttons[7]
                // Their 'value' property holds the float (0.0 - 1.0)
                const ltVal = gp.buttons[6].value;
                const rtVal = gp.buttons[7].value;

                document.getElementById('fill-lt').style.height = (ltVal * 100) + '%';
                document.getElementById('fill-rt').style.height = (rtVal * 100) + '%';
                
                document.getElementById('mon-lt').innerText = ltVal.toFixed(3);
                document.getElementById('mon-rt').innerText = rtVal.toFixed(3);

                // STICKS (Axes)
                const lx = gp.axes[0], ly = gp.axes[1];
                const rx = gp.axes[2], ry = gp.axes[3];

                // Visual Stick Movement
                const lsEl = document.getElementById('b10');
                const rsEl = document.getElementById('b11');
                
                // Add pressed class if stick moved significantly (Deadzone visual)
                if(Math.abs(lx)>0.2 || Math.abs(ly)>0.2) lsEl.classList.add('pressed'); else if(!gp.buttons[10].pressed) lsEl.classList.remove('pressed');
                if(Math.abs(rx)>0.2 || Math.abs(ry)>0.2) rsEl.classList.add('pressed'); else if(!gp.buttons[11].pressed) rsEl.classList.remove('pressed');

                // Monitor Values
                document.getElementById('mon-ls').innerText = `${lx.toFixed(3)}, ${ly.toFixed(3)}`;
                document.getElementById('mon-rs').innerText = `${rx.toFixed(3)}, ${ry.toFixed(3)}`;

                requestAnimationFrame(updateLoop);
            }
        }

        function testRumble() {
            if(gpIndex === null) return;
            const gp = navigator.getGamepads()[gpIndex];
            if(gp && gp.vibrationActuator) {
                gp.vibrationActuator.playEffect("dual-rumble", {
                    startDelay: 0, duration: 500, weakMagnitude: 1.0, strongMagnitude: 1.0
                });
            } else {
                alert("Vibration not supported by Browser or Device.");
            }
        }

        // --- 2. SONY DUALSHOCK WEBHID LOGIC ---
        const dsBtn = document.getElementById('ds-connect');
        const f1 = document.getElementById('f1'), f2 = document.getElementById('f2');
        const v1 = document.getElementById('ds-val-1'), v2 = document.getElementById('ds-val-2');

        dsBtn.addEventListener('click', async () => {
            if (!navigator.hid) { alert("WebHID not supported. Use Chrome/Edge desktop."); return; }
            
            try {
                // Filter for Sony (0x054C)
                const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x054C }] });
                if (devices.length === 0) return;

                const device = devices[0];
                await device.open();
                dsBtn.innerText = "CONNECTED";
                dsBtn.disabled = true;

                device.addEventListener('inputreport', event => {
                    const data = new Uint8Array(event.data.buffer);
                    
                    // DS4 usually starts touchpad data at byte 35 (Report ID 0x01/0x11)
                    // DualSense might vary slightly, but this is the standard HID offset
                    let offset = 35;

                    // --- Finger 1 ---
                    // Packet info: [Counter+ID] [X-Low] [X-High+Y-High] [Y-Low]
                    const f1Info = data[offset];
                    const f1Active = !(f1Info & 0x80); // 7th bit 0 = Active

                    if (f1Active) {
                        const x = ((data[offset+2] & 0x0F) << 8) | data[offset+1];
                        const y = (data[offset+3] << 4) | ((data[offset+2] & 0xF0) >> 4);
                        
                        // Map to CSS (DS4 Resolution ~1920x940)
                        f1.style.left = (x / 1920 * 100) + '%';
                        f1.style.top = (y / 940 * 100) + '%';
                        f1.style.opacity = 1;
                        v1.innerText = `X:${x} Y:${y}`;
                    } else {
                        f1.style.opacity = 0;
                        v1.innerText = "Inactive";
                    }

                    // --- Finger 2 ---
                    // Offset + 4 bytes
                    const f2Info = data[offset+4];
                    const f2Active = !(f2Info & 0x80);

                    if (f2Active) {
                        const x = ((data[offset+6] & 0x0F) << 8) | data[offset+5];
                        const y = (data[offset+7] << 4) | ((data[offset+6] & 0xF0) >> 4);
                        
                        f2.style.left = (x / 1920 * 100) + '%';
                        f2.style.top = (y / 940 * 100) + '%';
                        f2.style.opacity = 1;
                        v2.innerText = `X:${x} Y:${y}`;
                    } else {
                        f2.style.opacity = 0;
                        v2.innerText = "Inactive";
                    }
                });

            } catch (err) {
                alert("Connection Failed: " + err.message);
            }
        });
    </script>
</body>
</html>
