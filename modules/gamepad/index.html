<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>GXDiag - Pro Controller Tester</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        /* LAYOUT UTAMA */
        .main-grid {
            display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px;
            width: 100%; max-width: 1200px; align-items: start;
        }

        /* --- SECTION 1: STANDARD CONTROLLER --- */
        .gp-visual-wrapper {
            position: relative; width: 460px; height: 320px; margin: 0 auto;
            background: linear-gradient(145deg, #252525, #151515);
            border-radius: 80px 80px 140px 140px; border: 2px solid #444;
            box-shadow: inset 0 0 30px #000;
        }
        
        /* Tombol Umum */
        .btn-gp {
            position: absolute; display: flex; align-items: center; justify-content: center;
            background: #333; color: #888; border: 2px solid #444; 
            font-size: 9px; font-weight: bold; transition: 0.05s;
        }
        .btn-gp.pressed { background: #00e5ff; color: #000; box-shadow: 0 0 15px #00e5ff; border-color: #fff; transform: scale(0.95); }

        /* Posisi Tombol Face & Dpad */
        .gp-round { width: 34px; height: 34px; border-radius: 50%; }
        .pos-y { top: 60px; right: 80px; } .pos-x { top: 95px; right: 115px; } 
        .pos-b { top: 95px; right: 45px; } .pos-a { top: 130px; right: 80px; }
        .gp-dpad { width: 28px; height: 28px; border-radius: 4px; }
        .pos-du { top: 95px; left: 95px; } .pos-dd { top: 155px; left: 95px; } 
        .pos-dl { top: 125px; left: 65px; } .pos-dr { top: 125px; left: 125px; }

        /* Analog Sticks */
        .gp-stick { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #555; background: #222; }
        .gp-stick.pressed { background: #005577; }
        .pos-ls { top: 60px; left: 60px; } .pos-rs { top: 160px; right: 90px; }

        /* Shoulders (LB/RB) */
        .gp-sh { width: 80px; height: 20px; border-radius: 10px; top: -10px; }
        .pos-lb { left: 40px; } .pos-rb { right: 40px; }

        /* Triggers (LT/RT) - ANALOG BAR VISUALIZER */
        .trigger-bar-container {
            position: absolute; top: -40px; width: 60px; height: 100px;
            background: #111; border-radius: 10px; border: 1px solid #444; overflow: hidden;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .pos-lt-bar { left: 30px; } .pos-rt-bar { right: 30px; }
        .trigger-fill { width: 100%; background: #00e5ff; height: 0%; transition: height 0.05s; }
        .trigger-val { position: absolute; bottom: 5px; color: #fff; font-size: 0.7rem; font-family: monospace; z-index: 2; width: 100%; text-align: center; }

        /* Center Buttons */
        .gp-small { width: 22px; height: 22px; border-radius: 50%; top: 110px; }
        .pos-sel { left: 190px; } .pos-start { right: 190px; } .pos-home { left: 219px; top: 70px; }

        /* PADDLES & EXTRAS (P1-P4) */
        .gp-paddle { width: 25px; height: 45px; border-radius: 8px; bottom: 50px; background: #1a1a1a; border-color: #333; }
        .pos-p1 { left: 170px; bottom: 70px; } .pos-p2 { right: 170px; bottom: 70px; } 
        .pos-p3 { left: 140px; bottom: 30px; } .pos-p4 { right: 140px; bottom: 30px; }
        .paddle-label { position: absolute; bottom: 10px; width: 100%; text-align: center; color: #555; font-size: 0.7rem; letter-spacing: 1px; }

        /* DATA MONITOR (Deadzone & Values) */
        .monitor-panel {
            margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px dashed #444;
        }
        .mon-row { display: flex; justify-content: space-between; font-family: monospace; font-size: 0.85rem; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 3px; margin-bottom: 3px;}
        .mon-val { color: #00e5ff; font-weight: bold; }

        /* --- SECTION 2: SONY TOUCHPAD (WEBHID) --- */
        .ds-wrapper {
            background: #1e1e1e; border: 1px solid #333; border-radius: 15px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; height: 100%;
        }
        .ds-touchpad {
            width: 100%; height: 200px; background: #222; border: 2px solid #444;
            border-radius: 15px; position: relative; overflow: hidden; margin: 20px 0;
            box-shadow: inset 0 0 30px #000;
        }
        .ds-finger {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.7rem; opacity: 0; transition: opacity 0.1s; pointer-events: none;
        }
        #f1 { background: #00e5ff; box-shadow: 0 0 15px #00e5ff; }
        #f2 { background: #ff4081; box-shadow: 0 0 15px #ff4081; }
        
        .connect-btn { 
            background: #00a2ff; color: #fff; border: none; padding: 10px 20px; 
            border-radius: 30px; font-weight: bold; cursor: pointer; 
        }
        .connect-btn:hover { background: #fff; color: #00a2ff; }

        @media (max-width: 1000px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-btn">‚Üê MENU</a>
    <h2>Pro Controller & Deadzone Tester</h2>

    <div class="main-grid">
        
        <div class="panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="gp-name" style="color:#00e5ff; font-weight:bold;">Connect Controller...</span>
                <button onclick="testRumble()" style="background:#ff4081; border:none; color:white; padding:3px 10px; border-radius:4px; font-size:0.7rem; cursor:pointer;">TEST RUMBLE</button>
            </div>

            <div class="gp-visual-wrapper">
                <div class="trigger-bar-container pos-lt-bar">
                    <div class="trigger-val" id="val-lt">L</div>
                    <div class="trigger-fill" id="fill-lt"></div>
                </div>
                <div class="trigger-bar-container pos-rt-bar">
                    <div class="trigger-val" id="val-rt">R</div>
                    <div class="trigger-fill" id="fill-rt"></div>
                </div>

                <div class="btn-gp gp-sh pos-lb" id="b4">LB</div>
                <div class="btn-gp gp-sh pos-rb" id="b5">RB</div>

                <div class="btn-gp gp-stick pos-ls" id="b10">L3</div>
                <div class="btn-gp gp-stick pos-rs" id="b11">R3</div>

                <div class="btn-gp gp-dpad pos-du" id="b12">‚ñ≤</div>
                <div class="btn-gp gp-dpad pos-dd" id="b13">‚ñº</div>
                <div class="btn-gp gp-dpad pos-dl" id="b14">‚óÄ</div>
                <div class="btn-gp gp-dpad pos-dr" id="b15">‚ñ∂</div>

                <div class="btn-gp gp-round pos-y" id="b3" style="color:#eadd00">Y</div>
                <div class="btn-gp gp-round pos-x" id="b2" style="color:#0088ff">X</div>
                <div class="btn-gp gp-round pos-a" id="b0" style="color:#00ff88">A</div>
                <div class="btn-gp gp-round pos-b" id="b1" style="color:#ff4040">B</div>

                <div class="btn-gp gp-small pos-sel" id="b8">Sel</div>
                <div class="btn-gp gp-small pos-start" id="b9">Sta</div>
                <div class="btn-gp gp-small pos-home" id="b16">‚åÇ</div>

                <div class="btn-gp gp-paddle pos-p1" id="b17">P1</div>
                <div class="btn-gp gp-paddle pos-p2" id="b18">P2</div>
                <div class="btn-gp gp-paddle pos-p3" id="b19">P3</div>
                <div class="btn-gp gp-paddle pos-p4" id="b20">P4</div>
                
                <div class="paddle-label">BACK PADDLES / EXTRA BUTTONS</div>
            </div>

            <div class="monitor-panel">
                <div class="mon-row"><span>L-STICK (Axis 0,1)</span> <span class="mon-val" id="mon-ls">0.00, 0.00</span></div>
                <div class="mon-row"><span>R-STICK (Axis 2,3)</span> <span class="mon-val" id="mon-rs">0.00, 0.00</span></div>
                <div class="mon-row"><span>L-TRIGGER (Deadzone)</span> <span class="mon-val" id="mon-lt">0.00</span></div>
                <div class="mon-row"><span>R-TRIGGER (Deadzone)</span> <span class="mon-val" id="mon-rt">0.00</span></div>
            </div>
        </div>

        <div class="ds-wrapper">
            <h3 style="margin-top:0; color:#00a2ff">Sony Touchpad Raw Data</h3>
            <p style="font-size:0.8rem; color:#888; text-align:center;">
                Requires USB Cable + Chrome/Edge.<br>Close Steam/DS4Windows to avoid conflicts.
            </p>
            <button class="connect-btn" id="ds-connect">üîå CONNECT USB</button>
            
            <div class="ds-touchpad">
                <div id="f1" class="ds-finger">1</div>
                <div id="f2" class="ds-finger">2</div>
                <div style="position:absolute; top:50%; width:100%; height:1px; background:#333;"></div>
                <div style="position:absolute; left:50%; height:100%; width:1px; background:#333;"></div>
            </div>
            
            <div style="width:100%; font-family:monospace; font-size:0.85rem;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #444; padding:5px;">
                    <span>Finger 1:</span> <span style="color:#00e5ff" id="ds-val-1">Inactive</span>
                </div>
                <div style="display:flex; justify-content:space-between; padding:5px;">
                    <span>Finger 2:</span> <span style="color:#ff4081" id="ds-val-2">Inactive</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. STANDARD GAMEPAD LOGIC ---
        let gpIndex = null;
        window.addEventListener("gamepadconnected", e => {
            gpIndex = e.gamepad.index;
            document.getElementById('gp-name').innerText = "Connected: " + e.gamepad.id.substring(0, 20) + "...";
            updateLoop();
        });
        window.addEventListener("gamepaddisconnected", e => {
            gpIndex = null;
            document.getElementById('gp-name').innerText = "Connect Controller...";
        });

        function updateLoop() {
            if(gpIndex === null) return;
            const gp = navigator.getGamepads()[gpIndex];
            if(gp) {
                // BUTTONS (0 - 20)
                // Note: Standard only goes to 16. 17-20 are typically Paddles on supported devices/browsers.
                for (let i = 0; i < gp.buttons.length; i++) {
                    const el = document.getElementById('b' + i);
                    if (el) {
                        if (gp.buttons[i].pressed) el.classList.add('pressed');
                        else el.classList.remove('pressed');
                    }
                }

                // TRIGGERS (Analog Handling - Axis vs Button Value)
                // HTML5 Gamepad API maps Triggers to buttons[6] and buttons[7]
                // Their 'value' property holds the float (0.0 - 1.0)
                const ltVal = gp.buttons[6].value;
                const rtVal = gp.buttons[7].value;

                document.getElementById('fill-lt').style.height = (ltVal * 100) + '%';
                document.getElementById('fill-rt').style.height = (rtVal * 100) + '%';
                
                document.getElementById('mon-lt').innerText = ltVal.toFixed(3);
                document.getElementById('mon-rt').innerText = rtVal.toFixed(3);

                // STICKS (Axes)
                const lx = gp.axes[0], ly = gp.axes[1];
                const rx = gp.axes[2], ry = gp.axes[3];

                // Visual Stick Movement
                const lsEl = document.getElementById('b10');
                const rsEl = document.getElementById('b11');
                
                // Add pressed class if stick moved significantly (Deadzone visual)
                if(Math.abs(lx)>0.2 || Math.abs(ly)>0.2) lsEl.classList.add('pressed'); else if(!gp.buttons[10].pressed) lsEl.classList.remove('pressed');
                if(Math.abs(rx)>0.2 || Math.abs(ry)>0.2) rsEl.classList.add('pressed'); else if(!gp.buttons[11].pressed) rsEl.classList.remove('pressed');

                // Monitor Values
                document.getElementById('mon-ls').innerText = `${lx.toFixed(3)}, ${ly.toFixed(3)}`;
                document.getElementById('mon-rs').innerText = `${rx.toFixed(3)}, ${ry.toFixed(3)}`;

                requestAnimationFrame(updateLoop);
            }
        }

        function testRumble() {
            if(gpIndex === null) return;
            const gp = navigator.getGamepads()[gpIndex];
            if(gp && gp.vibrationActuator) {
                gp.vibrationActuator.playEffect("dual-rumble", {
                    startDelay: 0, duration: 500, weakMagnitude: 1.0, strongMagnitude: 1.0
                });
            } else {
                alert("Vibration not supported by Browser or Device.");
            }
        }

        // --- 2. SONY DUALSHOCK WEBHID LOGIC ---
        const dsBtn = document.getElementById('ds-connect');
        const f1 = document.getElementById('f1'), f2 = document.getElementById('f2');
        const v1 = document.getElementById('ds-val-1'), v2 = document.getElementById('ds-val-2');

        dsBtn.addEventListener('click', async () => {
            if (!navigator.hid) { alert("WebHID not supported. Use Chrome/Edge desktop."); return; }
            
            try {
                // Filter for Sony (0x054C)
                const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x054C }] });
                if (devices.length === 0) return;

                const device = devices[0];
                await device.open();
                dsBtn.innerText = "CONNECTED";
                dsBtn.disabled = true;

                device.addEventListener('inputreport', event => {
                    const data = new Uint8Array(event.data.buffer);
                    
                    // DS4 usually starts touchpad data at byte 35 (Report ID 0x01/0x11)
                    // DualSense might vary slightly, but this is the standard HID offset
                    let offset = 35;

                    // --- Finger 1 ---
                    // Packet info: [Counter+ID] [X-Low] [X-High+Y-High] [Y-Low]
                    const f1Info = data[offset];
                    const f1Active = !(f1Info & 0x80); // 7th bit 0 = Active

                    if (f1Active) {
                        const x = ((data[offset+2] & 0x0F) << 8) | data[offset+1];
                        const y = (data[offset+3] << 4) | ((data[offset+2] & 0xF0) >> 4);
                        
                        // Map to CSS (DS4 Resolution ~1920x940)
                        f1.style.left = (x / 1920 * 100) + '%';
                        f1.style.top = (y / 940 * 100) + '%';
                        f1.style.opacity = 1;
                        v1.innerText = `X:${x} Y:${y}`;
                    } else {
                        f1.style.opacity = 0;
                        v1.innerText = "Inactive";
                    }

                    // --- Finger 2 ---
                    // Offset + 4 bytes
                    const f2Info = data[offset+4];
                    const f2Active = !(f2Info & 0x80);

                    if (f2Active) {
                        const x = ((data[offset+6] & 0x0F) << 8) | data[offset+5];
                        const y = (data[offset+7] << 4) | ((data[offset+6] & 0xF0) >> 4);
                        
                        f2.style.left = (x / 1920 * 100) + '%';
                        f2.style.top = (y / 940 * 100) + '%';
                        f2.style.opacity = 1;
                        v2.innerText = `X:${x} Y:${y}`;
                    } else {
                        f2.style.opacity = 0;
                        v2.innerText = "Inactive";
                    }
                });

            } catch (err) {
                alert("Connection Failed: " + err.message);
            }
        });
    </script>
</body>
</html>
