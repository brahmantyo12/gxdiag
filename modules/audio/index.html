<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Audio</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        * { box-sizing: border-box; }
        body { 
            background: #0a0a0a; color: #fff; height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; margin: 0;
        }
        
        /* HEADER FIXED */
        .mod-header { 
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333; 
            flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
        }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; display: flex; align-items: center; gap: 8px; }

        /* SCROLLABLE CONTAINER */
        .container { 
            flex-grow: 1; padding: 20px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 25px; 
            align-items: center; 
            width: 100%; max-width: 600px; margin: 0 auto;
        }

        /* CARD STYLE */
        .card-box {
            background: #151515; border: 1px solid #333; border-radius: 12px;
            padding: 20px; width: 100%; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .card-title { margin: 0 0 15px 0; font-size: 1rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* STEREO */
        .stereo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .spk-btn { 
            padding: 15px 0; background: #222; border: 1px solid #444; color: #fff; 
            cursor: pointer; border-radius: 8px; font-weight: bold; width: 100%; transition: 0.2s;
        }
        .spk-btn:active { background: #00e5ff; color: #000; border-color: #00e5ff; }

        /* FREQ GEN */
        .range-slider { width: 100%; margin: 20px 0; cursor: pointer; }
        .freq-display { font-size: 2.5rem; color: #00e5ff; font-family: monospace; font-weight: bold; line-height: 1; }
        .play-tone-btn { 
            background: #ff4081; border: none; padding: 12px 30px; color: #fff; 
            border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1rem; 
            width: 100%; max-width: 200px; transition: 0.2s;
        }
        
        /* MIC */
        .mic-wrapper { 
            width: 30px; height: 120px; background: #222; border-radius: 15px; 
            position: relative; overflow: hidden; margin: 0 auto 15px auto; border: 1px solid #333;
        }
        .mic-fill { 
            position: absolute; bottom: 0; width: 100%; height: 0%; 
            background: linear-gradient(to top, #00ff88, #ffff00, #ff0000); 
            transition: height 0.05s ease-out; 
        }
        .mic-btn {
            background: #222; color: #00e5ff; border: 1px solid #00e5ff; 
            padding: 8px 20px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
        }

        /* RESPONSIVE TWEAKS */
        @media (max-height: 600px) {
            .container { gap: 15px; padding: 10px; }
            .card-box { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="mod-header">
        <a href="../../index.html" class="back-btn"><span>‚Üê</span> DASHBOARD</a>
        <div style="font-size:0.9rem; color:#888;">AUDIO SYSTEM</div>
    </div>

    <div class="container">
        <div class="card-box">
            <h3 class="card-title">Stereo Channels</h3>
            <div class="stereo-grid">
                <button class="spk-btn" onclick="playTone(0)">LEFT</button>
                <button class="spk-btn" onclick="playTone(1)">RIGHT</button>
            </div>
        </div>

        <div class="card-box">
            <h3 class="card-title">Frequency Sweep</h3>
            <div class="freq-display"><span id="freq-val">440</span><span style="font-size:1rem; color:#666; margin-left:5px;">Hz</span></div>
            <input type="range" min="20" max="20000" value="440" class="range-slider" id="freq-slider" oninput="updateFreq(this.value)">
            <div style="display:flex; justify-content:space-between; color:#666; font-size:0.7rem; margin-top:-10px; margin-bottom:15px;">
                <span>20Hz</span><span>20kHz</span>
            </div>
            <button class="play-tone-btn" id="btn-tone" onclick="toggleOscillator()">START TONE</button>
        </div>

        <div class="card-box">
            <h3 class="card-title">Microphone Input</h3>
            <div class="mic-wrapper"><div class="mic-fill" id="mic-level"></div></div>
            <button class="mic-btn" onclick="initMic()">Enable & Test Mic</button>
        </div>
    </div>

    <script>
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // STEREO LOGIC
        function playTone(panVal) {
            if(ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const panner = ctx.createStereoPanner();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(panner);
            panner.connect(ctx.destination);
            
            panner.pan.value = panVal === 0 ? -1 : 1;
            gain.gain.value = 0.5;
            
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
            osc.stop(ctx.currentTime + 0.5);
        }

        // FREQ GEN LOGIC
        let osc = null;
        const slider = document.getElementById('freq-slider');
        const disp = document.getElementById('freq-val');
        const btn = document.getElementById('btn-tone');

        function updateFreq(val) {
            disp.innerText = val;
            if(osc) osc.frequency.value = val;
        }

        function toggleOscillator() {
            if(ctx.state === 'suspended') ctx.resume();
            
            if(osc) {
                osc.stop(); osc = null;
                btn.innerText = "START TONE";
                btn.style.background = "#ff4081";
            } else {
                osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = slider.value;
                osc.connect(ctx.destination);
                osc.start();
                btn.innerText = "STOP TONE";
                btn.style.background = "#333";
            }
        }

        // MIC LOGIC
        async function initMic() {
            try {
                if(ctx.state === 'suspended') ctx.resume();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = ctx.createMediaStreamSource(stream);
                const analyser = ctx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                const data = new Uint8Array(analyser.frequencyBinCount);
                
                function loop() {
                    analyser.getByteFrequencyData(data);
                    // Hitung rata-rata volume
                    let sum = 0;
                    for(let i = 0; i < data.length; i++) sum += data[i];
                    const vol = sum / data.length;
                    
                    // Normalisasi visual (amplifikasi sedikit biar kelihatan gerak)
                    let visualHeight = Math.min(100, vol * 1.5); 
                    document.getElementById('mic-level').style.height = visualHeight + "%";
                    requestAnimationFrame(loop);
                }
                loop();
            } catch(e) {
                alert("Microphone access denied or not found.");
            }
        }
    </script>
</body>
</html>
