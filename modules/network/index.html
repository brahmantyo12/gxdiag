<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Network Intelligence</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body { 
            background: #0b0b0b; display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; font-family: 'Segoe UI', monospace;
        }
        
        .mod-header {
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333; 
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; }
        
        /* LAYOUT UTAMA */
        .net-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; gap: 20px; padding: 20px; overflow-y: auto;
        }

        /* --- 1. PING RADAR UI --- */
        .ping-wrapper { position: relative; width: 220px; height: 220px; margin-bottom: 10px; }
        .ping-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, #1a1a1a 40%, #000 100%);
            border: 4px solid #333; border-top-color: #00e5ff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); transition: border-color 0.2s;
            position: relative; z-index: 2;
        }
        .ping-circle.live { animation: spinBorder 2s linear infinite; }
        @keyframes spinBorder { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .ping-inner-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; z-index: 3;}

        .ping-val { font-size: 4.5rem; font-weight: 800; color: #fff; line-height: 0.9; }
        .ping-label { color: #888; text-transform: uppercase; font-size: 0.8rem; margin-top: 10px; letter-spacing: 1px; }

        .pulse-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid #00e5ff; opacity: 0; z-index: 1;
        }
        .pulsing { animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

        /* GRAPH & METRICS BLOCK */
        .metrics-block {
            width: 100%; max-width: 600px; background: #111; border: 1px solid #333; 
            padding: 20px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px;
        }

        .ping-graph {
            display: flex; align-items: flex-end; gap: 2px; height: 50px; width: 100%; 
            background: rgba(0,0,0,0.3); border-bottom: 1px solid #333;
        }
        .bar { flex: 1; background: #333; transition: height 0.2s; opacity: 0.7; }
        .bar.high { background: #ff4081; }
        .bar.med { background: #ffb300; }
        .bar.low { background: #00ff88; }

        .speed-box {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;
        }
        .sb-item { background: #1a1a1a; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
        .sb-val { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .sb-lbl { font-size: 0.7rem; color: #666; letter-spacing: 1px; margin-top: 2px;}
        .sb-sub-val { font-size: 0.8rem; color: #00e5ff; font-weight: bold; margin-top: 4px; font-family: monospace; }

        .btn-group { display: flex; gap: 10px; width: 100%; max-width: 600px; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold;
            background: #222; color: #ccc; border: 1px solid #444; transition: 0.3s; font-size: 0.9rem;
        }
        .action-btn:hover { background: #333; color: #fff; }
        .action-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; box-shadow: 0 0 15px rgba(0,229,255,0.3); }

        /* --- INTELLIGENCE SECTION --- */
        .intel-section { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }

        .isp-card {
            background: #151515; padding: 20px; border-radius: 12px; border: 1px solid #333;
            display: flex; align-items: center; gap: 20px;
        }
        .isp-logo { font-size: 2.5rem; }
        .isp-info { flex-grow: 1; }
        .isp-name { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .isp-asn { font-size: 0.85rem; color: #666; }

        /* IP STACK GRID (NEW) */
        .ip-stack-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .ip-card {
            background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; gap: 5px; position: relative; overflow: hidden;
        }
        .ip-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        }
        .ip-card.v4::before { background: #00ff88; }
        .ip-card.v6::before { background: #00e5ff; }
        
        .ip-label { font-size: 0.7rem; color: #888; font-weight: bold; display: flex; justify-content: space-between;}
        .ip-addr { font-family: monospace; font-size: 1rem; color: #fff; word-break: break-all; }
        .ip-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; }
        .ip-badge.active { background: rgba(0, 255, 136, 0.2); color: #00ff88; }

        .vpn-alert {
            padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9rem; display: none;
        }
        .vpn-safe { background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; }
        .vpn-warn { background: rgba(255, 64, 129, 0.1); color: #ff4081; border: 1px solid #ff4081; }

        .geo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .geo-card {
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .geo-title { font-size: 0.8rem; color: #00e5ff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
        .geo-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #bbb; }
        .geo-val { color: #fff; font-weight: bold; text-align: right; }

        /* DEVICE INFO */
        .dev-info { font-size: 0.7rem; color: #555; text-align: center; margin-top: 10px; font-family: sans-serif; }

        @media (max-width: 600px) {
            .geo-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="mod-header">
        <a href="../../index.html" class="back-btn">‚Üê DASHBOARD</a>
        <div style="font-size:0.8rem; color:#666;">NETWORK INTELLIGENCE</div>
    </div>

    <div class="net-container">
        
        <div class="ping-wrapper">
            <div class="pulse-ring" id="pulse"></div>
            <div class="ping-circle" id="main-circle"></div>
            <div class="ping-inner-content">
                <div class="ping-val" id="ping-text">--</div>
                <div class="ping-label">MS LATENCY</div>
            </div>
        </div>

        <div class="metrics-block">
            <div class="ping-graph" id="graph"></div>
            <div class="speed-box">
                <div class="sb-item">
                    <div class="sb-val" id="jitter-val">0 ms</div>
                    <div class="sb-lbl">JITTER</div>
                </div>
                <div class="sb-item">
                    <div class="sb-val" id="dl-speed">-</div>
                    <div class="sb-lbl">SPEED (Megabit/s)</div>
                    <div class="sb-sub-val" id="dl-speed-byte"></div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="action-btn" id="btn-ping" onclick="togglePing()">‚ñ∂ Start Live Ping</button>
            <button class="action-btn" id="btn-speed" onclick="runSpeedTest()">‚ö° Run Speed Test</button>
        </div>

        <div class="intel-section">
            <div class="isp-card">
                <div class="isp-logo">üåê</div>
                <div class="isp-info">
                    <div class="isp-name" id="isp-name">Detecting ISP...</div>
                    <div class="isp-asn" id="isp-asn">ASN: -</div>
                </div>
            </div>

            <div class="ip-stack-grid">
                <div class="ip-card v4">
                    <div class="ip-label">
                        <span>IPv4 ADDRESS</span>
                        <span class="ip-badge active">Primary</span>
                    </div>
                    <div class="ip-addr" id="ip-v4">Scanning...</div>
                </div>
                <div class="ip-card v6">
                    <div class="ip-label">
                        <span>IPv6 ADDRESS</span>
                        <span class="ip-badge" id="v6-badge">Checking...</span>
                    </div>
                    <div class="ip-addr" id="ip-v6" style="color:#666;">Not Detected / Unavailable</div>
                </div>
            </div>

            <div class="vpn-alert" id="vpn-status">Thinking...</div>

            <div class="geo-grid">
                <div class="geo-card">
                    <div class="geo-title">üåç LOGICAL LOCATION (IP)</div>
                    <div class="geo-row"><span>City</span> <span class="geo-val" id="ip-city">-</span></div>
                    <div class="geo-row"><span>Region</span> <span class="geo-val" id="ip-region">-</span></div>
                    <div class="geo-row"><span>Country</span> <span class="geo-val" id="ip-country">-</span></div>
                    <div class="geo-row"><span>Coords</span> <span class="geo-val" id="ip-coords" style="font-size:0.7rem">-</span></div>
                </div>

                <div class="geo-card">
                    <div class="geo-title">üõ∞Ô∏è PHYSICAL LOCATION (GPS)</div>
                    <div class="geo-row"><span>Accuracy</span> <span class="geo-val" id="gps-acc">-</span></div>
                    <div class="geo-row"><span>Speed</span> <span class="geo-val" id="gps-spd">-</span></div>
                    <div class="geo-row"><span>Coords</span> <span class="geo-val" id="gps-coords" style="font-size:0.7rem; color:#ff4081;">Waiting Permission...</span></div>
                    <button class="action-btn" style="width:100%; margin-top:10px; font-size:0.8rem; padding:8px;" onclick="getGPS()">üìç Get GPS Data</button>
                </div>
            </div>

            <div class="dev-info" id="dev-info">Device Fingerprint...</div>
        </div>

    </div>

    <script>
        // --- GRAPH SETUP ---
        const graph = document.getElementById('graph');
        const bars = [];
        for(let i=0; i<30; i++) {
            const b = document.createElement('div');
            b.className = 'bar'; b.style.height = '5%';
            graph.appendChild(b);
            bars.push(b);
        }

        // --- PING LOGIC ---
        let isPing = false;
        let lastPing = 0;
        
        async function doPing() {
            if(!isPing) return;
            const start = performance.now();
            try {
                await fetch('https://1.1.1.1/cdn-cgi/trace', { mode: 'no-cors', cache: 'no-store' });
                const ping = Math.round(performance.now() - start);
                updatePingUI(ping);
                if(isPing) setTimeout(doPing, 1000);
            } catch(e) {
                if(isPing) setTimeout(doPing, 1000);
            }
        }

        function updatePingUI(ping) {
            const txt = document.getElementById('ping-text');
            const circle = document.getElementById('main-circle');
            const pulse = document.getElementById('pulse');
            
            txt.innerText = ping;
            
            if(lastPing > 0) {
                const jitter = Math.abs(ping - lastPing);
                document.getElementById('jitter-val').innerText = `¬±${jitter} ms`;
            }
            lastPing = ping;

            let color = "#00ff88"; 
            if(ping > 100) color = "#ffb300"; 
            if(ping > 200) color = "#ff4081"; 

            txt.style.color = color;
            circle.style.borderTopColor = color;
            pulse.style.borderColor = color;

            for(let i=0; i<29; i++) {
                bars[i].style.height = bars[i+1].style.height;
                bars[i].className = bars[i+1].className;
            }
            const last = bars[29];
            const h = Math.min(100, Math.max(10, (ping / 300) * 100)); 
            last.style.height = h + "%";
            last.className = 'bar ' + (ping < 100 ? 'low' : (ping < 200 ? 'med' : 'high'));
        }

        function togglePing() {
            isPing = !isPing;
            const btn = document.getElementById('btn-ping');
            const circle = document.getElementById('main-circle');
            const pulse = document.getElementById('pulse');

            if(isPing) {
                btn.innerText = "‚èπ Stop Ping";
                btn.classList.add('active');
                circle.classList.add('live'); 
                pulse.classList.add('pulsing');
                doPing();
            } else {
                btn.innerText = "‚ñ∂ Start Live Ping";
                btn.classList.remove('active');
                circle.classList.remove('live');
                pulse.classList.remove('pulsing');
            }
        }

        // --- SPEED TEST ---
        async function runSpeedTest() {
            const el = document.getElementById('dl-speed');
            const elByte = document.getElementById('dl-speed-byte');
            const btn = document.getElementById('btn-speed');
            
            btn.disabled = true;
            btn.innerText = "‚è≥ Testing...";
            el.innerText = "...";
            elByte.innerText = "";
            
            const start = performance.now();
            const testFileUrl = 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Mount_Everest_as_seen_from_Drukair2_PLW_edit.jpg'; 
            
            try {
                const res = await fetch(testFileUrl + '?t=' + Math.random(), { cache: 'no-store' });
                if(!res.ok) throw new Error("Network Error");
                
                const blob = await res.blob();
                const end = performance.now();
                
                const sizeInBytes = blob.size; 
                const sizeInBits = sizeInBytes * 8;
                const durationInSeconds = (end - start) / 1000;
                
                const speedBps = sizeInBits / durationInSeconds;
                const speedMbps = (speedBps / (1024 * 1024)).toFixed(2); 

                const speedByteSec = sizeInBytes / durationInSeconds;
                const speedMBps = (speedByteSec / (1024 * 1024)).toFixed(2);
                
                el.innerText = speedMbps + " Mbps";
                elByte.innerText = `~ ${speedMBps} MB/s`;

            } catch(e) {
                console.error(e);
                el.innerText = "Error";
                elByte.innerText = "Check Connection";
            } finally {
                btn.disabled = false;
                btn.innerText = "‚ö° Run Speed Test";
            }
        }

        // --- DUAL STACK IP DETECTION ---
        
        // 1. Get ISP & Geo Data (via Main IP)
        async function getMainIntel() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                document.getElementById('isp-name').innerText = data.org || "Unknown ISP";
                document.getElementById('isp-asn').innerText = data.asn || "-";
                document.getElementById('ip-city').innerText = data.city;
                document.getElementById('ip-region').innerText = data.region;
                document.getElementById('ip-country').innerText = data.country_name;
                document.getElementById('ip-coords').innerText = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                
                // Store for VPN calc
                window.ipLat = data.latitude;
                window.ipLon = data.longitude;

                // Coba cek ulang VPN jika GPS sudah ada
                const gpsCoords = document.getElementById('gps-coords').innerText;
                if(gpsCoords.includes(",")) {
                    const [gLat, gLon] = gpsCoords.split(',').map(Number);
                    analyzeVPN(gLat, gLon);
                }

            } catch(e) {
                document.getElementById('isp-name').innerText = "ISP Info Failed";
            }
        }

        // 2. Force IPv4 Check
        async function getIPv4() {
            try {
                const res = await fetch('https://api4.ipify.org?format=json');
                const data = await res.json();
                document.getElementById('ip-v4').innerText = data.ip;
            } catch(e) {
                document.getElementById('ip-v4').innerText = "Not Available";
            }
        }

        // 3. Force IPv6 Check
        async function getIPv6() {
            try {
                const res = await fetch('https://api6.ipify.org?format=json');
                const data = await res.json();
                const el = document.getElementById('ip-v6');
                el.innerText = data.ip;
                el.style.color = "#00e5ff"; // Active color
                
                const badge = document.getElementById('v6-badge');
                badge.innerText = "Active";
                badge.classList.add('active');
            } catch(e) {
                // Keep default "Not Detected"
            }
        }

        // --- GPS & VPN DETECTION ---
        function getGPS() {
            if('geolocation' in navigator) {
                document.getElementById('gps-coords').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    document.getElementById('gps-coords').innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    document.getElementById('gps-acc').innerText = `¬±${pos.coords.accuracy.toFixed(0)}m`;
                    document.getElementById('gps-spd').innerText = pos.coords.speed ? `${(pos.coords.speed*3.6).toFixed(1)} km/h` : "0";

                    analyzeVPN(lat, lon);

                }, err => {
                    document.getElementById('gps-coords').innerText = "Denied / Error";
                }, { enableHighAccuracy: true });
            }
        }

        function analyzeVPN(gpsLat, gpsLon) {
            if(!window.ipLat) return; 

            const R = 6371; 
            const dLat = (gpsLat - window.ipLat) * Math.PI / 180;
            const dLon = (gpsLon - window.ipLon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(window.ipLat * Math.PI / 180) * Math.cos(gpsLat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c;

            const alertBox = document.getElementById('vpn-status');
            alertBox.style.display = 'block';

            if(dist > 100) {
                alertBox.className = 'vpn-alert vpn-warn';
                alertBox.innerHTML = `‚ö†Ô∏è DISTANCE ANOMALY: ~${dist.toFixed(0)}km Difference<br>Potential VPN / Proxy Detected`;
            } else {
                alertBox.className = 'vpn-alert vpn-safe';
                alertBox.innerHTML = `‚úÖ LOCATION MATCH: < ${dist.toFixed(0)}km Difference<br>Direct Connection Likely`;
            }
        }

        // --- DEVICE FINGERPRINT ---
        function showDeviceInfo() {
            const ua = navigator.userAgent;
            const screen = `${window.screen.width}x${window.screen.height}`;
            document.getElementById('dev-info').innerText = `UA: ${ua} | Screen: ${screen}`;
        }

        // EXECUTE
        getMainIntel();
        getIPv4();
        getIPv6();
        showDeviceInfo();
        togglePing(); 

    </script>
</body>
</html>
