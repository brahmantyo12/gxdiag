<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Network Intelligence</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body { 
            background: #0b0b0b; display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; font-family: 'Segoe UI', monospace;
        }
        
        .mod-header {
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333; 
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; }
        
        /* LAYOUT UTAMA */
        .net-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; gap: 25px; padding: 20px; overflow-y: auto;
        }

        /* --- 1. PING RADAR UI (RESTORED) --- */
        .ping-wrapper { position: relative; width: 220px; height: 220px; margin-bottom: 10px; }
        .ping-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, #1a1a1a 40%, #000 100%);
            border: 4px solid #333; border-top-color: #00e5ff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); transition: border-color 0.2s;
            position: relative; z-index: 2;
        }
        .ping-circle.live { animation: spinBorder 2s linear infinite; }
        @keyframes spinBorder { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Agar angka tidak ikut berputar */
        .ping-inner-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; z-index: 3;}

        .ping-val { font-size: 4.5rem; font-weight: 800; color: #fff; line-height: 0.9; }
        .ping-label { color: #888; text-transform: uppercase; font-size: 0.8rem; margin-top: 10px; letter-spacing: 1px; }

        /* PULSE EFFECT */
        .pulse-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; border: 2px solid #00e5ff; opacity: 0; z-index: 1;
        }
        .pulsing { animation: ripple 1.5s infinite; }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

        /* GRAPH & METRICS BLOCK */
        .metrics-block {
            width: 100%; max-width: 500px; background: #111; border: 1px solid #333; 
            padding: 20px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px;
        }

        /* PING GRAPH */
        .ping-graph {
            display: flex; align-items: flex-end; gap: 2px; height: 50px; width: 100%; 
            background: rgba(0,0,0,0.3); border-bottom: 1px solid #333;
        }
        .bar { flex: 1; background: #333; transition: height 0.2s; opacity: 0.7; }
        .bar.high { background: #ff4081; }
        .bar.med { background: #ffb300; }
        .bar.low { background: #00ff88; }

        /* SPEED & JITTER BOX */
        .speed-box {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;
        }
        .sb-item { background: #1a1a1a; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .sb-val { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .sb-lbl { font-size: 0.7rem; color: #666; letter-spacing: 1px; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; width: 100%; max-width: 500px; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold;
            background: #222; color: #ccc; border: 1px solid #444; transition: 0.3s; font-size: 0.9rem;
        }
        .action-btn:hover { background: #333; color: #fff; }
        .action-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; box-shadow: 0 0 15px rgba(0,229,255,0.3); }

        /* --- INTELLIGENCE SECTION --- */
        .intel-section { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }

        /* ISP INFO */
        .isp-card {
            background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
        }
        .isp-logo { font-size: 2rem; margin-right: 15px; }
        .isp-info { flex-grow: 1; }
        .isp-name { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .isp-asn { font-size: 0.8rem; color: #666; }

        /* VPN ALERT */
        .vpn-alert {
            padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 0.9rem; display: none;
        }
        .vpn-safe { background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; }
        .vpn-warn { background: rgba(255, 64, 129, 0.1); color: #ff4081; border: 1px solid #ff4081; }

        /* GEO GRID */
        .geo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .geo-card {
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .geo-title { font-size: 0.8rem; color: #00e5ff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
        .geo-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #bbb; }
        .geo-val { color: #fff; font-weight: bold; text-align: right; }

        @media (max-width: 600px) {
            .geo-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="mod-header">
        <a href="../../index.html" class="back-btn">‚Üê DASHBOARD</a>
        <div style="font-size:0.8rem; color:#666;">NETWORK INTELLIGENCE</div>
    </div>

    <div class="net-container">
        
        <div class="ping-wrapper">
            <div class="pulse-ring" id="pulse"></div>
            <div class="ping-circle" id="main-circle"></div>
            <div class="ping-inner-content">
                <div class="ping-val" id="ping-text">--</div>
                <div class="ping-label">MS LATENCY</div>
            </div>
        </div>

        <div class="metrics-block">
            <div class="ping-graph" id="graph"></div>
            <div class="speed-box">
                <div class="sb-item">
                    <div class="sb-val" id="jitter-val">0 ms</div>
                    <div class="sb-lbl">JITTER</div>
                </div>
                <div class="sb-item">
                    <div class="sb-val" id="dl-speed">-</div>
                    <div class="sb-lbl">EST. SPEED</div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="action-btn" id="btn-ping" onclick="togglePing()">‚ñ∂ Start Live Ping</button>
            <button class="action-btn" id="btn-speed" onclick="runSpeedTest()">‚ö° Run Speed Test</button>
        </div>

        <div class="intel-section">
            <div class="isp-card">
                <div class="isp-logo">üåê</div>
                <div class="isp-info">
                    <div class="isp-name" id="isp-name">Detecting ISP...</div>
                    <div class="isp-asn" id="isp-asn">ASN: -</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem; color:#888;">IPv4</div>
                    <div style="color:#00e5ff; font-family:monospace;" id="ip-addr">...</div>
                </div>
            </div>

            <div class="vpn-alert" id="vpn-status">Thinking...</div>

            <div class="geo-grid">
                <div class="geo-card">
                    <div class="geo-title">üåç NETWORK LOCATION (IP)</div>
                    <div class="geo-row"><span>City</span> <span class="geo-val" id="ip-city">-</span></div>
                    <div class="geo-row"><span>Country</span> <span class="geo-val" id="ip-country">-</span></div>
                    <div class="geo-row"><span>Coords</span> <span class="geo-val" id="ip-coords" style="font-size:0.7rem">-</span></div>
                </div>

                <div class="geo-card">
                    <div class="geo-title">üõ∞Ô∏è PHYSICAL LOCATION (GPS)</div>
                    <div class="geo-row"><span>Accuracy</span> <span class="geo-val" id="gps-acc">-</span></div>
                    <div class="geo-row"><span>Speed</span> <span class="geo-val" id="gps-spd">-</span></div>
                    <div class="geo-row"><span>Coords</span> <span class="geo-val" id="gps-coords" style="font-size:0.7rem; color:#ff4081;">Waiting Permission...</span></div>
                    <button class="action-btn" style="width:100%; margin-top:10px; font-size:0.8rem; padding:8px;" onclick="getGPS()">üìç Get GPS Data</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GRAPH SETUP ---
        const graph = document.getElementById('graph');
        const bars = [];
        for(let i=0; i<30; i++) {
            const b = document.createElement('div');
            b.className = 'bar'; b.style.height = '5%';
            graph.appendChild(b);
            bars.push(b);
        }

        // --- PING LOGIC (RADAR UI) ---
        let isPing = false;
        let lastPing = 0;
        
        async function doPing() {
            if(!isPing) return;
            const start = performance.now();
            try {
                // Gunakan Cloudflare Trace (No Cache)
                await fetch('https://1.1.1.1/cdn-cgi/trace', { mode: 'no-cors', cache: 'no-store' });
                const ping = Math.round(performance.now() - start);
                updatePingUI(ping);
                if(isPing) setTimeout(doPing, 1000);
            } catch(e) {
                if(isPing) setTimeout(doPing, 1000);
            }
        }

        function updatePingUI(ping) {
            const txt = document.getElementById('ping-text');
            const circle = document.getElementById('main-circle');
            const pulse = document.getElementById('pulse');
            
            txt.innerText = ping;
            
            // Jitter Calc
            if(lastPing > 0) {
                const jitter = Math.abs(ping - lastPing);
                document.getElementById('jitter-val').innerText = `¬±${jitter} ms`;
            }
            lastPing = ping;

            // Color Coding
            let color = "#00ff88"; // Good
            if(ping > 100) color = "#ffb300"; // Med
            if(ping > 200) color = "#ff4081"; // Bad

            txt.style.color = color;
            circle.style.borderTopColor = color;
            pulse.style.borderColor = color;

            // Graph Shift
            for(let i=0; i<29; i++) {
                bars[i].style.height = bars[i+1].style.height;
                bars[i].className = bars[i+1].className;
            }
            const last = bars[29];
            // Height logic: max height 100% at 300ms
            const h = Math.min(100, Math.max(10, (ping / 300) * 100)); 
            last.style.height = h + "%";
            last.className = 'bar ' + (ping < 100 ? 'low' : (ping < 200 ? 'med' : 'high'));
        }

        function togglePing() {
            isPing = !isPing;
            const btn = document.getElementById('btn-ping');
            const circle = document.getElementById('main-circle');
            const pulse = document.getElementById('pulse');

            if(isPing) {
                btn.innerText = "‚èπ Stop Ping";
                btn.classList.add('active');
                circle.classList.add('live'); // Spin border
                pulse.classList.add('pulsing'); // Pulse effect
                doPing();
            } else {
                btn.innerText = "‚ñ∂ Start Live Ping";
                btn.classList.remove('active');
                circle.classList.remove('live');
                pulse.classList.remove('pulsing');
            }
        }

        // --- SPEED TEST (CORS FIXED) ---
        // Menggunakan Gambar dari Wikimedia Commons (Server Cepat & CORS Friendly)
        async function runSpeedTest() {
            const el = document.getElementById('dl-speed');
            const btn = document.getElementById('btn-speed');
            
            btn.disabled = true;
            btn.innerText = "‚è≥ Testing...";
            el.innerText = "Testing...";
            
            const start = performance.now();
            
            // Link ke gambar HD di Wikimedia Commons (~2.5 MB)
            // Ini jauh lebih stabil daripada Unsplash dan mendukung CORS
            const testFileUrl = 'https://upload.wikimedia.org/wikipedia/commons/d/d1/Mount_Everest_as_seen_from_Drukair2_PLW_edit.jpg'; 
            
            try {
                // cache: no-store agar browser mendownload ulang, bukan ambil dari cache
                const res = await fetch(testFileUrl + '?t=' + Math.random(), { cache: 'no-store' });
                if(!res.ok) throw new Error("Network Error");
                
                const blob = await res.blob();
                const end = performance.now();
                
                const sizeInBytes = blob.size; 
                const sizeInBits = sizeInBytes * 8;
                const durationInSeconds = (end - start) / 1000;
                
                // Hitung Mbps (Megabits per second)
                const speedBps = sizeInBits / durationInSeconds;
                const speedMbps = (speedBps / (1024 * 1024)).toFixed(2); 
                
                el.innerText = speedMbps + " Mbps";
            } catch(e) {
                console.error(e);
                el.innerText = "Blocked/Error";
            } finally {
                btn.disabled = false;
                btn.innerText = "‚ö° Run Speed Test";
            }
        }

        // --- INTELLIGENCE (IP & ISP) ---
        let ipLat = 0, ipLon = 0;

        async function getIPInfo() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                document.getElementById('ip-addr').innerText = data.ip;
                document.getElementById('isp-name').innerText = data.org || "Unknown ISP";
                document.getElementById('isp-asn').innerText = data.asn || "-";
                
                document.getElementById('ip-city').innerText = data.city;
                document.getElementById('ip-country').innerText = data.country_name;
                document.getElementById('ip-coords').innerText = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                
                ipLat = data.latitude;
                ipLon = data.longitude;
                
                // Coba analisis jika data GPS sudah ada sebelumnya
                const gpsCoords = document.getElementById('gps-coords').innerText;
                if(gpsCoords.includes(",")) {
                    const [gLat, gLon] = gpsCoords.split(',').map(Number);
                    analyzeVPN(gLat, gLon);
                }

            } catch(e) {
                console.error("IP Fetch Error");
                document.getElementById('isp-name').innerText = "Failed to fetch ISP data";
            }
        }

        // --- GPS & VPN DETECTION ---
        function getGPS() {
            if('geolocation' in navigator) {
                document.getElementById('gps-coords').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    document.getElementById('gps-coords').innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    document.getElementById('gps-acc').innerText = `¬±${pos.coords.accuracy.toFixed(0)}m`;
                    document.getElementById('gps-spd').innerText = pos.coords.speed ? `${(pos.coords.speed*3.6).toFixed(1)} km/h` : "0";

                    // ANALISIS VPN
                    analyzeVPN(lat, lon);

                }, err => {
                    document.getElementById('gps-coords').innerText = "Denied / Error";
                }, { enableHighAccuracy: true });
            }
        }

        function analyzeVPN(gpsLat, gpsLon) {
            if(ipLat === 0) return; // Belum ada data IP

            // Haversine Formula
            const R = 6371; // km
            const dLat = (gpsLat - ipLat) * Math.PI / 180;
            const dLon = (gpsLon - ipLon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(ipLat * Math.PI / 180) * Math.cos(gpsLat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c;

            const alertBox = document.getElementById('vpn-status');
            alertBox.style.display = 'block';

            // Ambang batas 100km
            if(dist > 100) {
                alertBox.className = 'vpn-alert vpn-warn';
                alertBox.innerHTML = `‚ö†Ô∏è DISTANCE ANOMALY: ~${dist.toFixed(0)}km Difference<br>Potential VPN / Proxy Detected`;
            } else {
                alertBox.className = 'vpn-alert vpn-safe';
                alertBox.innerHTML = `‚úÖ LOCATION MATCH: < ${dist.toFixed(0)}km Difference<br>Direct Connection Likely`;
            }
        }

        // Auto Run
        getIPInfo();
        togglePing(); // Auto start ping

    </script>
</body>
</html>
