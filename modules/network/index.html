<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Network Intelligence</title>
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body { 
            background: #0b0b0b; display: flex; flex-direction: column; 
            min-height: 100vh; overflow-x: hidden; font-family: 'Segoe UI', monospace;
        }
        
        .mod-header {
            padding: 15px 20px; background: #111; border-bottom: 1px solid #333; 
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .back-btn { text-decoration: none; color: #fff; font-weight: bold; }
        
        /* LAYOUT UTAMA */
        .net-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; gap: 20px; padding: 20px; overflow-y: auto;
        }

        /* 1. PING SECTION */
        .ping-section {
            width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center;
            background: #111; border: 1px solid #333; padding: 20px; border-radius: 15px;
        }
        .ping-val-large { font-size: 3.5rem; font-weight: 800; color: #fff; line-height: 1; }
        .ping-label { color: #888; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 15px; }
        
        .ping-graph {
            display: flex; align-items: flex-end; gap: 2px; height: 50px; width: 100%; 
            background: rgba(0,0,0,0.3); border-bottom: 1px solid #333; margin-bottom: 15px;
        }
        .bar { flex: 1; background: #333; transition: height 0.2s; opacity: 0.7; }
        .bar.high { background: #ff4081; }
        .bar.med { background: #ffb300; }
        .bar.low { background: #00ff88; }

        /* 2. SPEED TEST (Mini) */
        .speed-box {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px;
        }
        .sb-item { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; }
        .sb-val { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .sb-lbl { font-size: 0.7rem; color: #666; }

        /* 3. GEO INTELLIGENCE (IP vs GPS) */
        .geo-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px;
        }
        .geo-card {
            background: #151515; border: 1px solid #333; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .geo-title { font-size: 0.8rem; color: #00e5ff; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }
        .geo-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: #bbb; }
        .geo-val { color: #fff; font-weight: bold; text-align: right; }
        
        /* ISP INFO */
        .isp-card {
            width: 100%; max-width: 600px; background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
        }
        .isp-logo { font-size: 2rem; margin-right: 15px; }
        .isp-info { flex-grow: 1; }
        .isp-name { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .isp-asn { font-size: 0.8rem; color: #666; }

        /* VPN ALERT */
        .vpn-alert {
            width: 100%; max-width: 600px; padding: 10px; border-radius: 8px; 
            text-align: center; font-weight: bold; font-size: 0.9rem; display: none;
        }
        .vpn-safe { background: rgba(0, 255, 136, 0.1); color: #00ff88; border: 1px solid #00ff88; }
        .vpn-warn { background: rgba(255, 64, 129, 0.1); color: #ff4081; border: 1px solid #ff4081; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn {
            padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold;
            background: #222; color: #ccc; border: 1px solid #444; transition: 0.3s;
        }
        .action-btn:hover { background: #333; color: #fff; }
        .action-btn.active { background: #00e5ff; color: #000; border-color: #00e5ff; }

        @media (max-width: 600px) {
            .geo-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="mod-header">
        <a href="../../index.html" class="back-btn">‚Üê DASHBOARD</a>
        <div style="font-size:0.8rem; color:#666;">NETWORK INTEL</div>
    </div>

    <div class="net-container">
        
        <div class="ping-section">
            <div class="ping-val-large" id="ping-text">--</div>
            <div class="ping-label">MS LATENCY (CLOUDFLARE)</div>
            
            <div class="ping-graph" id="graph"></div>
            
            <div class="speed-box">
                <div class="sb-item">
                    <div class="sb-val" id="jitter-val">0 ms</div>
                    <div class="sb-lbl">JITTER</div>
                </div>
                <div class="sb-item">
                    <div class="sb-val" id="dl-speed">-</div>
                    <div class="sb-lbl">EST. SPEED (MB/s)</div>
                </div>
            </div>

            <div class="btn-group">
                <button class="action-btn" id="btn-ping" onclick="togglePing()">‚ñ∂ Start Ping</button>
                <button class="action-btn" onclick="runSpeedTest()">‚ö° Test Speed</button>
            </div>
        </div>

        <div class="isp-card">
            <div class="isp-logo">üåê</div>
            <div class="isp-info">
                <div class="isp-name" id="isp-name">Detecting ISP...</div>
                <div class="isp-asn" id="isp-asn">ASN: -</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.8rem; color:#888;">IPv4</div>
                <div style="color:#00e5ff; font-family:monospace;" id="ip-addr">...</div>
            </div>
        </div>

        <div class="vpn-alert" id="vpn-status">Thinking...</div>

        <div class="geo-grid">
            <div class="geo-card">
                <div class="geo-title">üåç NETWORK LOCATION (IP)</div>
                <div class="geo-row"><span>City</span> <span class="geo-val" id="ip-city">-</span></div>
                <div class="geo-row"><span>Region</span> <span class="geo-val" id="ip-region">-</span></div>
                <div class="geo-row"><span>Country</span> <span class="geo-val" id="ip-country">-</span></div>
                <div class="geo-row"><span>Coords</span> <span class="geo-val" id="ip-coords" style="font-size:0.7rem">-</span></div>
            </div>

            <div class="geo-card">
                <div class="geo-title">üõ∞Ô∏è PHYSICAL LOCATION (GPS)</div>
                <div class="geo-row"><span>Accuracy</span> <span class="geo-val" id="gps-acc">-</span></div>
                <div class="geo-row"><span>Altitude</span> <span class="geo-val" id="gps-alt">-</span></div>
                <div class="geo-row"><span>Speed</span> <span class="geo-val" id="gps-spd">-</span></div>
                <div class="geo-row"><span>Coords</span> <span class="geo-val" id="gps-coords" style="font-size:0.7rem; color:#ff4081;">Waiting Permission...</span></div>
                <button class="action-btn" style="width:100%; margin-top:10px; font-size:0.8rem;" onclick="getGPS()">üìç Get GPS</button>
            </div>
        </div>

    </div>

    <script>
        // --- GRAPH SETUP ---
        const graph = document.getElementById('graph');
        const bars = [];
        for(let i=0; i<30; i++) {
            const b = document.createElement('div');
            b.className = 'bar'; b.style.height = '5%';
            graph.appendChild(b);
            bars.push(b);
        }

        // --- PING LOGIC ---
        let isPing = false;
        let lastPing = 0;
        
        async function doPing() {
            if(!isPing) return;
            const start = performance.now();
            try {
                await fetch('https://1.1.1.1/cdn-cgi/trace', { mode: 'no-cors', cache: 'no-store' });
                const ping = Math.round(performance.now() - start);
                updatePingUI(ping);
                if(isPing) setTimeout(doPing, 1000);
            } catch(e) {
                if(isPing) setTimeout(doPing, 1000);
            }
        }

        function updatePingUI(ping) {
            document.getElementById('ping-text').innerText = ping;
            
            // Jitter
            if(lastPing > 0) {
                const jitter = Math.abs(ping - lastPing);
                document.getElementById('jitter-val').innerText = `¬±${jitter} ms`;
            }
            lastPing = ping;

            // Color
            const txt = document.getElementById('ping-text');
            if(ping < 50) txt.style.color = "#00ff88";
            else if(ping < 150) txt.style.color = "#ffb300";
            else txt.style.color = "#ff4081";

            // Graph Shift
            for(let i=0; i<29; i++) {
                bars[i].style.height = bars[i+1].style.height;
                bars[i].className = bars[i+1].className;
            }
            const last = bars[29];
            const h = Math.min(100, Math.max(10, (ping/200)*100));
            last.style.height = h + "%";
            last.className = 'bar ' + (ping < 50 ? 'low' : (ping < 150 ? 'med' : 'high'));
        }

        function togglePing() {
            isPing = !isPing;
            const btn = document.getElementById('btn-ping');
            if(isPing) {
                btn.innerText = "‚èπ Stop";
                btn.classList.add('active');
                doPing();
            } else {
                btn.innerText = "‚ñ∂ Start Ping";
                btn.classList.remove('active');
            }
        }

        // --- SPEED TEST (Download 500KB Image) ---
        async function runSpeedTest() {
            const el = document.getElementById('dl-speed');
            el.innerText = "Testing...";
            const start = performance.now();
            // Fetch random image from Unsplash (approx 200-500KB)
            try {
                const res = await fetch('https://source.unsplash.com/random/800x600?' + Math.random());
                const blob = await res.blob();
                const end = performance.now();
                
                const size = blob.size; // bytes
                const duration = (end - start) / 1000; // seconds
                const speedBps = size / duration;
                const speedMBps = (speedBps / (1024*1024)).toFixed(2);
                
                el.innerText = speedMBps + " MB/s";
            } catch(e) {
                el.innerText = "Error";
            }
        }

        // --- INTELLIGENCE (IP & ISP) ---
        let ipLat = 0, ipLon = 0;

        async function getIPInfo() {
            try {
                // Using ipapi.co (Free Tier, No Key needed for low usage)
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                
                document.getElementById('ip-addr').innerText = data.ip;
                document.getElementById('isp-name').innerText = data.org || "Unknown ISP";
                document.getElementById('isp-asn').innerText = data.asn || "-";
                
                document.getElementById('ip-city').innerText = data.city;
                document.getElementById('ip-region').innerText = data.region;
                document.getElementById('ip-country').innerText = data.country_name;
                document.getElementById('ip-coords').innerText = `${data.latitude}, ${data.longitude}`;
                
                ipLat = data.latitude;
                ipLon = data.longitude;

            } catch(e) {
                console.error("IP Fetch Error");
                document.getElementById('isp-name').innerText = "Failed to fetch ISP";
            }
        }

        // --- GPS & VPN DETECTION ---
        function getGPS() {
            if('geolocation' in navigator) {
                document.getElementById('gps-coords').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    document.getElementById('gps-coords').innerText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    document.getElementById('gps-acc').innerText = `¬±${pos.coords.accuracy}m`;
                    document.getElementById('gps-alt').innerText = pos.coords.altitude ? `${pos.coords.altitude}m` : "N/A";
                    document.getElementById('gps-spd').innerText = pos.coords.speed ? `${(pos.coords.speed*3.6).toFixed(1)} km/h` : "0";

                    // ANALISIS VPN
                    analyzeVPN(lat, lon);

                }, err => {
                    document.getElementById('gps-coords').innerText = "Denied / Error";
                }, { enableHighAccuracy: true });
            }
        }

        function analyzeVPN(gpsLat, gpsLon) {
            if(ipLat === 0) return; // Belum ada data IP

            // Hitung jarak (Haversine Formula Simple)
            const R = 6371; // km
            const dLat = (gpsLat - ipLat) * Math.PI / 180;
            const dLon = (gpsLon - ipLon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(ipLat * Math.PI / 180) * Math.cos(gpsLat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c; // Jarak dalam KM

            const alertBox = document.getElementById('vpn-status');
            alertBox.style.display = 'block';

            if(dist > 100) {
                // Jarak IP dan GPS lebih dari 100km -> Kemungkinan VPN/Proxy
                alertBox.className = 'vpn-alert vpn-warn';
                alertBox.innerHTML = `‚ö†Ô∏è DISTANCE ANOMALY: ${dist.toFixed(0)}km Difference<br>Potential VPN / Proxy Detected`;
            } else {
                // Jarak dekat -> Direct Connection
                alertBox.className = 'vpn-alert vpn-safe';
                alertBox.innerHTML = `‚úÖ LOCATION MATCH: < ${dist.toFixed(0)}km Difference<br>Direct Connection Likely`;
            }
        }

        // Auto Run IP Check
        getIPInfo();
        togglePing(); // Auto start ping

    </script>
</body>
</html>
