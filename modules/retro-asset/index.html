<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GXDiag - Retro Asset Studio</title>
    <meta name="theme-color" content="#1a1a1a">
    
    <link rel="stylesheet" href="../../css/style.css">

    <style>
        body { background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; }
        
        .module-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .back-btn { text-decoration: none; color: #888; font-size: 1.1rem; }
        .back-btn:hover { color: #fff; }
        .module-title { font-size: 1.4rem; font-weight: 800; color: #76ff03; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(118, 255, 3, 0.3); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn {
            background: #1a1a1a; border: none; padding: 12px 20px; color: #888;
            cursor: pointer; font-size: 0.9rem; font-weight: bold; border-radius: 8px 8px 0 0;
            transition: 0.3s; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .tab-btn:hover { background: #222; color: #fff; }
        .tab-btn.active { background: #222; color: #76ff03; border-bottom: 3px solid #76ff03; }

        .panel { display: none; animation: fadeIn 0.3s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VISUAL STYLES (SPRITE) --- */
        .sprite-grid { display: grid; grid-template-columns: 1fr 300px; gap: 25px; align-items: start; }
        @media (max-width: 850px) { .sprite-grid { grid-template-columns: 1fr; } }

        .canvas-container {
            background: #151515; border: 2px solid #333; border-radius: 4px;
            display: flex; justify-content: center; align-items: center;
            overflow: auto; min-height: 400px; position: relative;
            background-image: linear-gradient(45deg, #1a1a1a 25%, transparent 25%), linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1a1a1a 75%), linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        canvas { image-rendering: pixelated; max-width: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .upload-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; background: rgba(0,0,0,0.7); transition: 0.3s;
        }
        .upload-overlay:hover { background: rgba(0,0,0,0.5); }

        .control-panel { background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 12px; }
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #76ff03; cursor: pointer; }
        
        .palette-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .p-btn { border: 1px solid #444; padding: 10px; font-size: 0.8rem; cursor: pointer; text-align: center; border-radius: 6px; font-weight: bold; color: #fff; transition: 0.2s; }
        .p-btn.active { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .gb-theme { background: linear-gradient(90deg, #0f380f, #8bac0f); color: #0f380f; }
        .bw-theme { background: linear-gradient(90deg, #000, #fff); color: #fff; }

        /* --- AUDIO STYLES (CHIPTUNE) --- */
        .audio-upload-zone {
            border: 2px dashed #444; padding: 40px; text-align: center; border-radius: 12px;
            cursor: pointer; margin-bottom: 20px; transition: 0.3s;
        }
        .audio-upload-zone:hover { border-color: #76ff03; background: rgba(118, 255, 3, 0.05); }

        .audio-player-ui {
            background: #151515; padding: 20px; border-radius: 12px; border: 1px solid #333;
            display: none; text-align: center;
        }

        .lcd-display {
            background: #6d860d; color: #0f380f; font-family: monospace; padding: 10px;
            border-radius: 4px; margin-bottom: 20px; font-weight: bold; border: 4px solid #333;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3); text-align: left;
        }

        .knob-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .btn-green {
            background: #76ff03; color: #000; width: 100%; padding: 15px; border: none; 
            border-radius: 8px; font-weight: 800; font-size: 1rem; cursor: pointer; 
            transition: 0.2s; text-transform: uppercase; margin-top: 10px;
        }
        .btn-green:hover { box-shadow: 0 0 15px rgba(118, 255, 3, 0.4); transform: translateY(-2px); }
        .btn-red { background: #ff4081; color: #fff; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-control { background: #333; color: #fff; border:1px solid #555; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }

    </style>
</head>
<body>

    <div class="container">
        <div class="module-header">
            <a href="../../index.html" class="back-btn">‚¨Ö Dashboard</a>
            <div class="module-title">Retro Asset Studio</div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('visual')">üëæ Visual Sprite (2D)</button>
            <button class="tab-btn" onclick="switchTab('audio')">üéµ Audio Bitcrusher (8-Bit)</button>
        </div>

        <div id="panel-visual" class="panel active">
            <div class="sprite-grid">
                <div class="canvas-container" id="drop-zone-img">
                    <canvas id="canvas"></canvas>
                    <div class="upload-overlay" id="upload-overlay-img" onclick="document.getElementById('file-input-img').click()">
                        <div style="font-size:3rem; margin-bottom:10px;">üñºÔ∏è</div>
                        <div style="font-weight:bold; color:#fff;">Upload Image</div>
                        <div style="font-size:0.8rem; color:#ccc;">JPG / PNG to Pixel Art</div>
                    </div>
                    <input type="file" id="file-input-img" accept="image/*" style="display:none;">
                </div>

                <div class="control-panel">
                    <div class="control-group">
                        <label>Pixel Size</label>
                        <input type="range" id="pixel-size" min="2" max="64" value="8" oninput="updateVal('px-val', this.value)">
                        <div style="text-align:right; color:#76ff03; font-size:0.8rem;" id="px-val">8 px</div>
                    </div>

                    <div class="control-group">
                        <label>Palette</label>
                        <div class="palette-btn-group">
                            <div class="p-btn active" style="background:#333;" onclick="setPalette('original', this)">Original</div>
                            <div class="p-btn gb-theme" onclick="setPalette('gameboy', this)">GameBoy</div>
                            <div class="p-btn bw-theme" onclick="setPalette('bw', this)">1-Bit</div>
                            <div class="p-btn" style="background: linear-gradient(90deg, #2b0057, #00e5ff);" onclick="setPalette('cyber', this)">Neon</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Contrast</label>
                        <input type="range" id="contrast" min="0" max="200" value="100">
                    </div>

                    <button class="btn-green" id="btn-dl-img" onclick="downloadSprite()" disabled>üíæ Save Sprite</button>
                </div>
            </div>
        </div>

        <div id="panel-audio" class="panel">
            <div class="audio-upload-zone" id="drop-zone-audio" onclick="document.getElementById('file-input-audio').click()">
                <div style="font-size:3rem; margin-bottom:10px;">üéß</div>
                <div style="font-weight:bold; color:#fff;">Upload Music (MP3/WAV)</div>
                <div style="font-size:0.8rem; color:#888;">Convert Modern Audio to Retro 8-Bit Style</div>
                <input type="file" id="file-input-audio" accept="audio/*" style="display:none;">
            </div>

            <div class="audio-player-ui" id="audio-ui">
                <div class="lcd-display">
                    STATUS: <span id="audio-status">READY</span><br>
                    BITS: <span id="lcd-bits">8</span> | RATE: <span id="lcd-rate">0.5</span>
                </div>

                <div class="knob-grid">
                    <div>
                        <label>Bit Depth (Crunch)</label>
                        <input type="range" id="bit-depth" min="2" max="16" step="1" value="8" oninput="updateAudioParams()">
                        <div style="font-size:0.8rem; color:#76ff03;">Low = More Noise</div>
                    </div>
                    <div>
                        <label>Downsample (Lofi)</label>
                        <input type="range" id="sample-rate" min="0.05" max="1" step="0.05" value="0.5" oninput="updateAudioParams()">
                        <div style="font-size:0.8rem; color:#76ff03;">Low = Muffled</div>
                    </div>
                </div>

                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                    <button class="btn-control" onclick="togglePlay()">‚ñ∂ Play / Pause</button>
                    <button class="btn-control" onclick="stopAudio()">‚ñ† Stop</button>
                </div>

                <button class="btn-green" id="btn-rec-audio" onclick="startRecording()">üî¥ Record & Save Result</button>
                <div style="font-size:0.7rem; color:#666; margin-top:5px;">*Click Record, let it play, then click Stop to save WAV.</div>
            </div>
        </div>

    </div>

    <script>
        // === TABS LOGIC ===
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(`panel-${tab}`).classList.add('active');
        }

        // ==========================================
        // === VISUAL SPRITE LOGIC (From previous) ===
        // ==========================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fileInputImg = document.getElementById('file-input-img');
        const overlayImg = document.getElementById('upload-overlay-img');
        let originalImg = null;
        let currentPalette = 'original';

        fileInputImg.addEventListener('change', (e) => handleImgFile(e.target.files[0]));
        document.getElementById('pixel-size').addEventListener('input', () => processImage());
        document.getElementById('contrast').addEventListener('input', () => processImage());

        function updateVal(id, val) { document.getElementById(id).innerText = val + ' px'; }
        
        function setPalette(p, btn) {
            currentPalette = p;
            document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            processImage();
        }

        function handleImgFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImg = new Image();
                originalImg.src = e.target.result;
                originalImg.onload = () => {
                    overlayImg.style.display = 'none';
                    document.getElementById('btn-dl-img').disabled = false;
                    processImage();
                }
            };
            reader.readAsDataURL(file);
        }

        function processImage() {
            if (!originalImg) return;
            const pixelSize = parseInt(document.getElementById('pixel-size').value);
            const contrast = parseInt(document.getElementById('contrast').value);
            
            const w = originalImg.width;
            const h = originalImg.height;
            const scaledW = Math.ceil(w / pixelSize);
            const scaledH = Math.ceil(h / pixelSize);

            canvas.width = w; canvas.height = h;
            ctx.imageSmoothingEnabled = false;

            const offCanvas = document.createElement('canvas');
            offCanvas.width = scaledW; offCanvas.height = scaledH;
            const offCtx = offCanvas.getContext('2d');
            
            offCtx.filter = `contrast(${contrast}%)`;
            offCtx.drawImage(originalImg, 0, 0, scaledW, scaledH);
            
            if (currentPalette !== 'original') {
                const imgData = offCtx.getImageData(0, 0, scaledW, scaledH);
                const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
                    if (currentPalette === 'gameboy') {
                        if (avg < 50) { data[i]=15; data[i+1]=56; data[i+2]=15; }
                        else if (avg < 120) { data[i]=48; data[i+1]=98; data[i+2]=48; }
                        else if (avg < 190) { data[i]=139; data[i+1]=172; data[i+2]=15; }
                        else { data[i]=155; data[i+1]=188; data[i+2]=15; }
                    } else if (currentPalette === 'bw') {
                        const c = avg > 128 ? 255 : 0;
                        data[i]=c; data[i+1]=c; data[i+2]=c;
                    } else if (currentPalette === 'cyber') {
                        if (avg < 100) { data[i]=43; data[i+1]=0; data[i+2]=87; }
                        else { data[i]=0; data[i+1]=229; data[i+2]=255; }
                    }
                }
                offCtx.putImageData(imgData, 0, 0);
            }
            ctx.drawImage(offCanvas, 0, 0, scaledW, scaledH, 0, 0, w, h);
        }

        function downloadSprite() {
            if(!originalImg) return;
            const link = document.createElement('a');
            link.download = 'GXDiag-Sprite.png';
            link.href = canvas.toDataURL();
            link.click();
        }


        // ==========================================
        // === AUDIO BITCRUSHER LOGIC ===
        // ==========================================
        const fileInputAudio = document.getElementById('file-input-audio');
        const audioUI = document.getElementById('audio-ui');
        const dropZoneAudio = document.getElementById('drop-zone-audio');
        
        let audioCtx;
        let sourceNode;
        let scriptNode;
        let isPlaying = false;
        let audioBuffer = null;
        let destNode; // For recording
        let mediaRecorder;
        let audioChunks = [];

        fileInputAudio.addEventListener('change', (e) => handleAudioFile(e.target.files[0]));

        async function handleAudioFile(file) {
            if(!file) return;
            dropZoneAudio.style.display = 'none';
            audioUI.style.display = 'block';
            document.getElementById('audio-status').innerText = "LOADING...";

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            
            document.getElementById('audio-status').innerText = "LOADED - READY";
        }

        function togglePlay() {
            if(isPlaying) {
                stopAudio();
            } else {
                playAudio();
            }
        }

        function playAudio() {
            if(!audioBuffer) return;
            
            // Re-create nodes (Audio nodes are use-once)
            sourceNode = audioCtx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.loop = true;

            // ScriptProcessor for Bitcrushing (Depreciated but widely supported fallback)
            // Buffer size 4096 gives balance between latency and performance
            scriptNode = audioCtx.createScriptProcessor(4096, 1, 1);
            
            // Parameters
            let bits = parseInt(document.getElementById('bit-depth').value);
            let normfreq = parseFloat(document.getElementById('sample-rate').value); // 0.1 to 1.0

            scriptNode.onaudioprocess = function(e) {
                const input = e.inputBuffer.getChannelData(0);
                const output = e.outputBuffer.getChannelData(0);
                
                // Real-time params update
                bits = parseInt(document.getElementById('bit-depth').value);
                normfreq = parseFloat(document.getElementById('sample-rate').value);

                const step = Math.pow(0.5, bits);
                let phaser = 0;
                let last = 0;

                for (let i = 0; i < input.length; i++) {
                    phaser += normfreq;
                    if (phaser >= 1.0) {
                        phaser -= 1.0;
                        last = step * Math.floor(input[i] / step + 0.5);
                    }
                    output[i] = last;
                }
            };

            // Destination for Recording
            destNode = audioCtx.createMediaStreamDestination();

            // Connect Graph: Source -> Bitcrusher -> Speakers & Recorder
            sourceNode.connect(scriptNode);
            scriptNode.connect(audioCtx.destination); // Hear it
            scriptNode.connect(destNode); // Record it

            sourceNode.start();
            isPlaying = true;
            document.getElementById('audio-status').innerText = "PLAYING 8-BIT...";
        }

        function stopAudio() {
            if(sourceNode) {
                try { sourceNode.stop(); } catch(e){}
                sourceNode.disconnect();
            }
            if(scriptNode) scriptNode.disconnect();
            isPlaying = false;
            document.getElementById('audio-status').innerText = "STOPPED";
        }

        function updateAudioParams() {
            const b = document.getElementById('bit-depth').value;
            const r = document.getElementById('sample-rate').value;
            document.getElementById('lcd-bits').innerText = b;
            document.getElementById('lcd-rate').innerText = r;
        }

        // Recording Output
        function startRecording() {
            const btn = document.getElementById('btn-rec-audio');
            if(btn.classList.contains('recording')) {
                // STOP RECORDING
                mediaRecorder.stop();
                btn.innerHTML = "üî¥ Record & Save Result";
                btn.classList.remove('recording', 'btn-red');
                btn.classList.add('btn-green');
                stopAudio();
            } else {
                // START RECORDING
                if(!isPlaying) playAudio();
                
                mediaRecorder = new MediaRecorder(destNode.stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "GXDiag-Retro-Audio.wav";
                    a.click();
                };
                mediaRecorder.start();
                
                btn.innerHTML = "‚èπ Stop Recording & Save";
                btn.classList.remove('btn-green');
                btn.classList.add('btn-red', 'recording');
            }
        }

    </script>
</body>
</html>
